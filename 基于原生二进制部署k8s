å‚è€ƒé“¾æ¥ï¼š
https://github.com/cby-chen/Kubernetes?tab=readme-ov-file

é›†ç¾¤èŠ‚ç‚¹æ¶æ„

| ä¸»æœºåç§°     | IPåœ°å€          | è¯´æ˜       | è½¯ä»¶                                                                                                                      |
| -------- | ------------- | -------- | ----------------------------------------------------------------------------------------------------------------------- |
| master01 | 192.168.0.111 | masterèŠ‚ç‚¹ | kube-apiserverã€kube-controller-managerã€kube-schedulerã€etcdã€  <br>kubeletã€kube-proxyã€nfs-clientã€haproxyã€keepalivedã€nginx |
| Master02 | 192.168.0.112 | masterèŠ‚ç‚¹ | kube-apiserverã€kube-controller-managerã€kube-schedulerã€etcdã€  <br>kubeletã€kube-proxyã€nfs-clientã€haproxyã€keepalivedã€nginx |
| Master03 | 192.168.0.113 | masterèŠ‚ç‚¹ | kube-apiserverã€kube-controller-managerã€kube-schedulerã€etcdã€  <br>kubeletã€kube-proxyã€nfs-clientã€haproxyã€keepalivedã€nginx |
| Node01   | 192.168.0.114 | nodeèŠ‚ç‚¹   | kubeletã€kube-proxyã€nfs-clientã€nginx                                                                                     |

å®‰è£…k8sç‰ˆæœ¬ï¼š1.31.0

æ³¨æ„äº‹é¡¹ï¼š
- é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥
- èŠ‚ç‚¹ä¹‹ä¸­ä¸å¯ä»¥æœ‰é‡å¤çš„ä¸»æœºåã€MAC åœ°å€æˆ– product_uuid
- ç¦ç”¨äº¤æ¢åˆ†åŒº


### å…¨éƒ¨ç»„ä»¶å®‰è£…é¡ºåºæ¦‚è§ˆï¼ˆ3 master + 1 nodeï¼‰ï¼š

| æ­¥éª¤  | è¯´æ˜                                              | éœ€è¦ç»„ä»¶                                  |
| --- | ----------------------------------------------- | ------------------------------------- |
| 1ï¸âƒ£ | å®‰è£…æ“ä½œç³»ç»ŸåŸºç¡€ä¾èµ–ã€å…³é—­é˜²ç«å¢™/SWAP                           | `iptables`, `modprobe`, `conntrack` ç­‰ |
| 2ï¸âƒ£ | å®‰è£… containerd å’Œ runc                            | è¿è¡Œæ—¶ä¾èµ–                                 |
| 3ï¸âƒ£ | å®‰è£…å’Œé…ç½® `etcd`ï¼ˆæ‰€æœ‰ masterï¼‰                         | `etcd` é›†ç¾¤å¯åŠ¨å¹¶äº’é€š                        |
| 4ï¸âƒ£ | å®‰è£… `kube-apiserver`ï¼ˆä¾èµ– etcdï¼‰                    | å¯åŠ¨æ—¶è®¿é—® etcd                            |
| 5ï¸âƒ£ | å®‰è£… `kube-controller-manager` / `kube-scheduler` |                                       |
| 6ï¸âƒ£ | å®‰è£… `kubelet` / `kube-proxy`                     | Node å’Œ Pod ç®¡ç†                         |
| 7ï¸âƒ£ | å®‰è£… `kubectl` å·¥å…·å¹¶é…ç½® kubeconfig                   | æ“ä½œé›†ç¾¤                                  |
| 8ï¸âƒ£ | é…ç½®ç½‘ç»œæ’ä»¶ï¼ˆå¦‚ CNIï¼šcalicoã€flannelï¼‰                    | Pod ç½‘ç»œé€šä¿¡                              |
| 9ï¸âƒ£ | åŠ å…¥ worker èŠ‚ç‚¹åˆ° master                            | ä½¿ç”¨ token æˆ–æ‰‹åŠ¨éƒ¨ç½²                        |
| ğŸ”Ÿ  | å®‰è£… ingressã€metrics-server ç­‰æ‰©å±•                   | è§‚å¯Ÿä¸è°ƒåº¦                                 |

## 1ï¼ŒèŠ‚ç‚¹åˆå§‹åŒ–
1.1ï¼ŒIPé…ç½®
==æ‰€æœ‰èŠ‚ç‚¹==
è™šæ‹Ÿæœºä¸‹ï¼Œä½¿ç”¨å…‹éš†çš„ä¸»æœºéœ€è¦æ³¨æ„ç½‘å¡çš„uuidå’ŒMachineIDï¼ŒåŒç½‘ç»œç¯å¢ƒä¸‹é‡å¤çš„uuidå’ŒMachineIDå¯èƒ½ä¼šé€ æˆipv6æ— æ³•dhcpæˆ–è€…è¢«ç³»ç»Ÿè¯†åˆ«ä¸ºç»Ÿä¸€è®¾å¤‡ã€‚æ— æ­¤æƒ…å†µæ— éœ€ä¿®æ”¹uuidå’ŒMachineIDï¼Œä»…æ ¹æ®éœ€è¦ä¿®æ”¹ipå³å¯ã€‚



æŸ¥è¯¢ç½‘å¡uuid:
`nmcli con show`
æŸ¥è¯¢MachineIDï¼š
`cat /etc/machine-id`

1.1.1ï¼Œé‡æ–°ç”ŸæˆMachineIDï¼š
`rm -rf /etc/machine-id; systemd-machine-id-setup`
`reboot`
1.1.2ï¼Œé‡æ–°ç”Ÿæˆuuidï¼š
åˆ é™¤å½“å‰ç½‘å¡é…ç½®ï¼Œé‡æ–°åˆ›å»ºå³å¯ã€‚
1.1.3ï¼Œå‘½ä»¤æ–¹å¼ï¼š
`nmcli con delete uuid 628b03ed-3c1e-32ea-b001-eb5b8ac73285`
`nmcli con add type ethernet ifname ens18 con-name ens18`
`nmcli con up ens18`
1.1.4ï¼Œç•Œé¢æ–¹å¼ï¼š
nmtui è¿›å…¥ç½‘ç»œé…ç½®ç•Œé¢ï¼Œåˆ é™¤å½“å‰ç½‘å¡è¿æ¥ï¼Œæ–°å»ºç½‘ç»œè¿æ¥ï¼Œä¿®æ”¹è¿æ¥åï¼Œip

1.2ï¼Œä¸»æœºåé…ç½®
==æ‰€æœ‰èŠ‚ç‚¹==
`hostnamectl set-hostname k8s-master01`

1.3ï¼Œé…ç½®yumæº
==æ‰€æœ‰èŠ‚ç‚¹==
æ ¹æ®è‡ªå·±çš„ç³»ç»Ÿç¯å¢ƒé…ç½®
dnf clean all && dnf makecache

1.4ï¼Œå®‰è£…å¸¸ç”¨å·¥å…·
==æ‰€æœ‰èŠ‚ç‚¹==
`dnf update -y && yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl bash-completion iproute iptables socat conntrack`

1.5ï¼Œå…³é—­é˜²ç«å¢™
==æ‰€æœ‰èŠ‚ç‚¹==
systemctl stop firewalld
systemctl disable --now firewalld

1.6ï¼Œå…³é—­selinux
==æ‰€æœ‰èŠ‚ç‚¹==
`setenforce 0`
`sed -ri 's/SELINUX=enforcing/SELINUX=disabled/' /etc/selinux/config`

1.7ï¼Œå…³é—­äº¤æ¢åˆ†åŒº
==æ‰€æœ‰èŠ‚ç‚¹==
```shell
swapoff -a
sed -i /^[^#]*swap*/s/^/\#/g /etc/fstab
```

1.8ï¼Œæ£€æŸ¥æ—¶é—´åŒæ­¥
==æ‰€æœ‰èŠ‚ç‚¹==
å¦‚æœä¸åŒæ­¥ï¼Œä½¿ç”¨chronyåŒæ­¥

1.9ï¼Œé…ç½®ulimit
==æ‰€æœ‰èŠ‚ç‚¹==
```shell
cat >> /etc/security/limits.conf <<EOF
* soft nofile 1048576
* hard nofile 1048576
* soft nproc 65536
* hard nproc 65536
* soft memlock unlimited
* hard memlock unlimited
EOF
```

1.10ï¼Œé…ç½®å…å¯†
==éé›†ç¾¤èŠ‚ç‚¹==
ç›®çš„æ˜¯ç”Ÿæˆä¸€ä¸ªå…¬é’¥ä¼ è¾“åˆ°é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹ï¼Œå®ç°è¿œç¨‹é›†ç¾¤èŠ‚ç‚¹å…å¯†
```shell
yum install -y sshpass
ssh-keygen -f /root/.ssh/id_rsa -P ''
export IP="192.168.1.31 192.168.1.32 192.168.1.33 192.168.1.34 192.168.1.35"
export SSHPASS=123123
for HOST in $IP;do
     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST
done
```

1.11ï¼Œå®‰è£…ipvsadm
==æ‰€æœ‰èŠ‚ç‚¹==
```shell
yum install ipvsadm ipset sysstat libseccomp -y

cat >> /etc/modules-load.d/ipvs.conf <<EOF
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
ip_tables
ip_set
xt_set
ipt_set
ipt_rpfilter
ipt_REJECT
ipip
EOF

systemctl restart systemd-modules-load.service

lsmod | grep -e ip_vs -e nf_conntrack
ip_vs_sh               16384  0
ip_vs_wrr              16384  0
ip_vs_rr               16384  0
ip_vs                 237568  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr
nf_conntrack          217088  3 nf_nat,nft_ct,ip_vs
nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs
nf_defrag_ipv4         16384  1 nf_conntrack
libcrc32c              16384  5 nf_conntrack,nf_nat,nf_tables,xfs,ip_vs
```

`ipvsadm`ã€`conntrack`æ˜¯kube-proxyç»„ä»¶ä½¿ç”¨ipvsæ¨¡å¼çš„å¿…è¦ç¯å¢ƒ

1.12ï¼Œä¿®æ”¹å†…æ ¸å‚æ•°
```shell
cat > /etc/sysctl.d/k8s.conf << EOF
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-arptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_local_reserved_ports = 30000-32767
net.core.netdev_max_backlog = 65535
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.core.somaxconn = 32768
net.ipv4.tcp_max_syn_backlog = 1048576
net.ipv4.neigh.default.gc_thresh1 = 512
net.ipv4.neigh.default.gc_thresh2 = 2048
net.ipv4.neigh.default.gc_thresh3 = 4096
net.ipv4.tcp_retries2 = 15
net.ipv4.tcp_max_tw_buckets = 1048576
net.ipv4.tcp_max_orphans = 65535
net.ipv4.tcp_keepalive_time = 600
net.ipv4.tcp_keepalive_intvl = 30
net.ipv4.tcp_keepalive_probes = 10
net.ipv4.udp_rmem_min = 131072
net.ipv4.udp_wmem_min = 131072
net.ipv4.conf.all.rp_filter = 0
net.ipv4.conf.default.rp_filter = 0
net.ipv4.conf.all.arp_accept = 1
net.ipv4.conf.default.arp_accept = 1
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.default.arp_ignore = 1
vm.max_map_count = 262144
vm.swappiness = 0
vm.overcommit_memory = 1
fs.inotify.max_user_instances = 524288
fs.inotify.max_user_watches = 10240001
fs.pipe-max-size = 4194304
fs.aio-max-nr = 262144
kernel.pid_max = 65535
kernel.watchdog_thresh = 5
kernel.hung_task_timeout_secs = 5
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
net.ipv6.conf.all.forwarding=1
EOF
```

`sysctl --system`

1.13ï¼Œé…ç½®hostsæœ¬åœ°è§£æ
==æ‰€æœ‰èŠ‚ç‚¹==
```shell
cat >> /etc/hosts << EOF
192.168.0.111 test-master-01
192.168.0.112 test-master-02
192.168.0.113 test-master-03
192.168.0.114 test-node-01
EOF
```

1.14ï¼Œå†™å…¥é…ç½®å¹¶æ¸…ç†å†…å­˜ç¼“å­˜
==æ‰€æœ‰èŠ‚ç‚¹==
sync
echo 3 > /proc/sys/vm/drop_caches

## 2ï¼Œå®‰è£…åŸºæœ¬ç»„ä»¶
æŸ¥è¯¢k8så¯¹åº”ç‰ˆæœ¬çš„åŸºç¡€ç»„ä»¶ç‰ˆæœ¬ï¼š
```shell
./kubeadm config images list --kubernetes-version v1.31.0
registry.k8s.io/kube-apiserver:v1.31.0
registry.k8s.io/kube-controller-manager:v1.31.0
registry.k8s.io/kube-scheduler:v1.31.0
registry.k8s.io/kube-proxy:v1.31.0
registry.k8s.io/coredns/coredns:v1.11.3
registry.k8s.io/pause:3.10
registry.k8s.io/etcd:3.5.15-0
```
kubeadmä¸‹è½½åœ°å€ï¼Œè¦ä¸‹è½½å…¶ä»–ç‰ˆæœ¬æˆ–å¹³å°ï¼Œæ›¿æ¢ç‰ˆæœ¬å·å’Œå¹³å°å³å¯ï¼š
`wget https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubeadm`
åœ¨ä»»æ„èŠ‚ç‚¹æˆ–å…¶å®ƒæœåŠ¡å™¨æ‰§è¡ŒæŸ¥è¯¢å³å¯

### 2.1ï¼Œå®‰è£…containerd
==æ‰€æœ‰èŠ‚ç‚¹==
- containerdå®˜ç½‘ï¼šhttps://containerd.io
- ä¸‹è½½é“¾æ¥ï¼šhttps://github.com/containerd/containerd/releases/download/v1.7.13/containerd-1.7.13-linux-amd64.tar.gz

è§£å‹åˆ°/usr
`tar -xzf containerd-1.7.13-linux-amd64.tar.gz -C /usr/`

é…ç½®systemd
```shell
cat > /etc/systemd/system/containerd.service <<EOF
[Unit]
Description=containerd container runtime
Documentation=https://containerd.io
After=network.target local-fs.target

[Service]
ExecStartPre=-/sbin/modprobe overlay
ExecStart=/usr/bin/containerd

Type=notify
Delegate=yes
KillMode=process
Restart=always
RestartSec=5
# Having non-zero Limit*s causes performance problems due to accounting overhead
# in the kernel. We recommend using cgroups to do container-local accounting.
LimitNPROC=infinity
LimitCORE=infinity
LimitNOFILE=1048576
# Comment TasksMax if your systemd version does not supports it.
# Only systemd 226 and above support this version.
TasksMax=infinity
OOMScoreAdjust=-999

[Install]
WantedBy=multi-user.target
EOF
```

é…ç½®Containerdæ‰€éœ€çš„æ¨¡å—
```shell
cat <<EOF > /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF
```

åŠ è½½æ¨¡å—
`systemctl restart systemd-modules-load.service`

åˆ›å»ºcontainerdé…ç½®æ–‡ä»¶
```shell
# åˆ›å»ºcontainerdé…ç½®æ–‡ä»¶
mkdir -p /etc/containerd
containerd config default > /etc/containerd/config.toml

# ä¿®æ”¹Containerdçš„é…ç½®æ–‡ä»¶
1,ä¿®æ”¹cgroupçš„é©±åŠ¨ç¨‹åºä¸ºsystemdï¼Œç”¨äºcontainerdåœ¨ä½¿ç”¨runcåˆ›å»ºå®¹å™¨æ—¶
SystemdCgroup = true
# sed -i "s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g" /etc/containerd/config.toml
2,ä¿®æ”¹pauseé•œåƒåœ°å€ï¼Œpauseæ˜¯ä¸€ä¸ªæ²™ç®±å®¹å™¨ï¼Œå­˜åœ¨äºæ¯ä¸ªpodä¸­
sandbox_image = "registry.cn-beijing.aliyuncs.com/kubesphereio/pause:3.9"
# sed -i "s#registry.k8s.io#registry.cn-beijing.aliyuncs.com/kubesphereio#g" /etc/containerd/config.toml
3,ï¼ˆæ­¤æ­¥éª¤å’Œç¬¬4æ­¥å†²çªï¼Œä»»é€‰å…¶ä¸€ï¼‰ä¿®æ”¹é•œåƒä»“åº“ç®¡ç†é…ç½®æ–‡ä»¶çš„è·¯å¾„
config_path = "/etc/containerd/certs.d"
# sed -i "s#config_path\ \=\ \"\"#config_path\ \=\ \"/etc/containerd/certs.d\"#g" /etc/containerd/config.toml

ç„¶åé…ç½®ä»“åº“åœ°å€æˆ–è€…åŠ é€Ÿï¼š
mkdir /etc/containerd/certs.d/docker.io -pv
cat > /etc/containerd/certs.d/docker.io/hosts.toml << EOF
server = "https://docker.io"
[host."https://jockerhub.com"]
  capabilities = ["pull", "resolve"]
EOF

4,æ·»åŠ é…ç½®ï¼Œè®¾ç½®é•œåƒåŠ é€Ÿåœ°å€æˆ–ç§æœ‰ä»“åº“
        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."docker.io"]
          endpoint = ["https://docker.alphesh.tech", "https://registry-1.docker.io"]
```

å¯¹åº”æˆªå›¾å¦‚ä¸‹ï¼š
1,
![[Pasted image 20250512115015.png]]
2,
![[Pasted image 20250512115039.png]]
3,
![[Pasted image 20250512114949.png]]
![[Pasted image 20250512114932.png]]
4,
![[Pasted image 20250512114607.png]]

!!! å…³äºè®¾ç½®é•œåƒåŠ é€Ÿåœ°å€çš„é…ç½®ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸ºç§æœ‰ä»“åº“(å‰æå¾—ä¿è¯å®‰è£…k8sæ‰€éœ€çš„æ‰€æœ‰ç»„ä»¶é•œåƒéƒ½å­˜åœ¨ç§æœ‰ä»“åº“å†…ï¼‰ï¼Œè‹¥ä½¿ç”¨ç§æœ‰ä»“åº“ï¼Œå¯¹äºçš„æ‰€æœ‰é•œåƒéƒ½éœ€è¦ä¿®æ”¹å…¶åœ°å€ï¼š

```toml
[plugins."io.containerd.grpc.v1.cri".registry]
  [plugins."io.containerd.grpc.v1.cri".registry.mirrors]
    [plugins."io.containerd.grpc.v1.cri".registry.mirrors."my.private.registry.com"]
      endpoint = ["https://my.private.registry.com"]

  [plugins."io.containerd.grpc.v1.cri".registry.configs]
    [plugins."io.containerd.grpc.v1.cri".registry.configs."my.private.registry.com".auth]
      username = "your-username"
      password = "your-password"
```
- my.private.registry.com æ›¿æ¢ä¸ºç§æœ‰ä»“åº“åœ°å€
- è´¦å·å¯†ç é…ç½®

å¯åŠ¨&&å¼€æœºå¯åŠ¨
`systemctl daemon-reload && systemctl start containerd.service && systemctl enable containerd.service`

#### 2.1.1ï¼Œå®‰è£…runc
==æ‰€æœ‰èŠ‚ç‚¹==
- runcæ˜¯containerdçš„é»˜è®¤è¿è¡Œæ—¶ï¼ŒäºŒè¿›åˆ¶éƒ¨ç½²containerdæ—¶ï¼Œè™½ç„¶é»˜è®¤å·²å¯ç”¨runcï¼Œä½†æ˜¯runcç¯å¢ƒéœ€è¦å•ç‹¬å®‰è£…ã€‚kubeleté€šè¿‡runcæ¥è°ƒç”¨containerdæ¥åˆ›å»ºå®¹å™¨
ä¸‹è½½é“¾æ¥ï¼šhttps://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64
`wget https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64`

æˆæƒ&&ç§»åŠ¨&&æŸ¥è¯¢ç‰ˆæœ¬
```shell
chmod +x soft/runc.amd64
mv soft/runc.amd64 /usr/local/bin/runc
runc -v
```
å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹
```bash
scp /usr/local/bin/runc 192.168.0.112:/usr/local/bin
```
#### 2.1.2ï¼Œé…ç½®cniåŸºç¡€ç¯å¢ƒ
==æ‰€æœ‰èŠ‚ç‚¹==
é¦–å…ˆç¡®å®šcontainerdçš„é…ç½®æ–‡ä»¶/etc/containerd/config.tomlï¼ŒcniäºŒè¿›åˆ¶æ–‡ä»¶çš„è·¯å¾„
```config
    [plugins."io.containerd.grpc.v1.cri".cni]
      bin_dir = "/opt/cni/bin"
      conf_dir = "/etc/cni/net.d"
```

ä¸‹è½½&&å®‰è£…
```shell
wget https://github.com/containernetworking/plugins/releases/download/v1.2.0/cni-plugins-linux-amd64-v1.2.0.tgz

mkdir -p /opt/cni/bin

tar -xf cni-plugins-linux-amd64-v1.2.0.tgz -C /opt/cni/bin
```
è¿™æ ·å°±å¯ä»¥äº†ï¼Œå½“å‰é˜¶æ®µä¸éœ€è¦æ·»åŠ cniçš„é…ç½®ï¼Œåç»­æ­¥éª¤ä¼šè‡ªåŠ¨å¤„ç†ã€‚
#### 2.1.3ï¼Œé…ç½®crictlå®¢æˆ·ç«¯
==æ‰€æœ‰èŠ‚ç‚¹==
- crictlæ˜¯containerdçš„ç®¡ç†å®¢æˆ·ç«¯
ä¸‹è½½åœ°å€ï¼šhttps://github.com/kubernetes-sigs/cri-tools/releases
`wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.29.0/crictl-v1.29.0-linux-amd64.tar.gz`

è§£å‹
`tar -xf crictl-v1.29.0-linux-amd64.tar.gz -C /usr/bin/`

ç”Ÿæˆé…ç½®æ–‡ä»¶
```shell
cat > /etc/crictl.yaml <<EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 5
debug: false
pull-image-on-create: false
EOF
```

é‡å¯containerdå¹¶æµ‹è¯•crictlä½¿ç”¨é…ç½®æˆåŠŸ
```shell
systemctl restart  containerd
crictl info
```

### 2.2ï¼Œè¯ä¹¦ç”Ÿæˆ
## K8s å„ç»„ä»¶æ‰€éœ€çš„ä¸»è¦è¯ä¹¦ï¼ˆæŒ‰æ ¹è¯ä¹¦åˆ†ç±»ï¼‰
ä¸åŒç”¨é€”çš„è¯ä¹¦æ¨èä½¿ç”¨ç‹¬ç«‹çš„CAæ ¹è¯ä¹¦ç­¾å‘ï¼Œk8sç›¸å…³ç»„ä»¶çš„è¯ä¹¦æ¨èä½¿ç”¨cfsslå·¥å…·ã€‚saè¯ä¹¦ä½¿ç”¨éx.509è¯ä¹¦ï¼Œæ‰€æœ‰æ¨èä½¿ç”¨opensslç”Ÿæˆã€‚

| CA å½’å±          | è¯ä¹¦åç§°                                                                                                                                                                                                                                                                                                                                                   | ä½œç”¨                                             |
| -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------- |
| etcd CA        | `ca.crt,ca.key,`<br>`server.crt,server.key,`<br>`peer.crt,peer.key,`<br>`apiserver-etcd-client.crt,`<br>`apiserver-etcd-client.key`                                                                                                                                                                                                                    | etcd é›†ç¾¤çš„ TLS è®¤è¯ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨ã€èŠ‚ç‚¹é—´é€šä¿¡å’Œå®¢æˆ·ç«¯è®¿é—®              |
| Kubernetes CA  | `ca.crt,ca.key,`-<br>`apiserver.crt,apiserver.key,`<br>`apiserver-kubelet-client.crt,`<br>`apiserver-kubelet-client.key,`<br>`kubelet-client.crt,`-<br>`kubelet-client.key,`-<br>`kubelet-server.crt,`-<br>`kubelet-server.key,`-<br>`admin.crt,admin.key,`<br>`controller-manager.crt,`<br>`controller-manager.key,`<br>`scheduler.crt,scheduler.key` | æ§åˆ¶é¢ç»„ä»¶ã€kubelet å’Œç®¡ç†å‘˜çš„ TLS è®¤è¯                     |
| Front Proxy CA | `front-proxy-ca.crt,`<br>`front-proxy-ca.key,`<br>`front-proxy-client.crt,`<br>`front-proxy-client.key`                                                                                                                                                                                                                                                | èšåˆ APIï¼ˆå¦‚ metrics-serverï¼‰ä¸ kube-apiserver çš„å®‰å…¨é€šä¿¡ |
| æ—  CAï¼ˆRSA å¯†é’¥å¯¹ï¼‰  | `sa.key,sa.pub`                                                                                                                                                                                                                                                                                                                                        | ServiceAccount token çš„ç­¾åå’ŒéªŒè¯ï¼Œopensslç”Ÿæˆ          |

è¯ä¹¦å­˜æ”¾ç›®å½•è§„åˆ’ï¼š
etcdï¼š/etc/kubernetes/pki/etcd/
Kubernetesç»„ä»¶ï¼š/etc/kubernetes/pki/kubernetes/
saï¼š/etc/kubernetes/pki/sa
front-proxyï¼š/etc/kubernetes/pki/front-proxy

```bash
mkdir -p /etc/kubernetes/pki/{etcd,kubernetes,sa,front-proxy}
```

#### 2.2.1ï¼Œå®‰è£…è¯ä¹¦ç”Ÿæˆå·¥å…·
`cfssl:`
cfsslåŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸‹è½½åœ°å€ï¼š
https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl-bundle_1.6.5_linux_amd64
https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64

```shell
# ä¸‹è½½ cfsslï¼Œæœ€æ–°ç‰ˆå³å¯
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssl-bundle_1.6.5_linux_amd64
wget https://github.com/cloudflare/cfssl/releases/download/v1.6.5/cfssljson_1.6.5_linux_amd64

chmod +x cfssl*

mv cfssl-bundle_1.6.5_linux_amd64 /usr/local/bin/cfssl
mv cfssljson_1.6.5_linux_amd64 /usr/local/bin/cfssljson
```
`openssl:`
```shell
yum install openssl
```

#### 2.2.2ï¼Œç”ŸæˆETCDè¯ä¹¦
etcdç›¸å…³çš„è¯ä¹¦ï¼Œå‡é€šè¿‡etcdçš„caè¯ä¹¦ç­¾å‘ï¼š
- etcd-serverï¼šé…ç½®åœ¨etcdçš„å¯åŠ¨å‘½ä»¤ä¸­ï¼Œç”¨äºå…¶ä»–ç»„ä»¶å’Œetcdçš„é€šä¿¡éªŒè¯ï¼›
- etcd-clientï¼šé…ç½®åœ¨etcdçš„å¯åŠ¨å‘½ä»¤å’Œetcdctlçš„ç¯å¢ƒå˜é‡ä¸­ï¼Œç”¨äºetcdctlè¯·æ±‚etcdçš„éªŒè¯ï¼›
- peerï¼šé…ç½®åœ¨etcdçš„å¯åŠ¨å‘½ä»¤ä¸­ï¼Œç”¨äºetcdé›†ç¾¤ä¸­èŠ‚ç‚¹é—´çš„åŠ å¯†é€šä¿¡ï¼›
- apiserver-etcd-clientï¼šé…ç½®åœ¨apiserverçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ˜¯etcdå’Œapiserveré—´çš„é€šä¿¡éªŒè¯

##### 2.2.2.1ï¼Œç”ŸæˆETCDçš„CAè¯ä¹¦
==åˆ›å»ºCAé…ç½®æ–‡ä»¶==
```shell
cat > ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "etcd": {
        "usages": ["signing", "key encipherment", "server auth", "client auth"],
        "expiry": "87600h"
      }
    }
  }
}
EOF
```
å‚æ•°è§£æï¼š
- defaultï¼šç”¨äºé»˜è®¤çš„ç­¾åé…ç½®
- profilesï¼šç”¨äºè‡ªå®šä¹‰çš„ç­¾åé…ç½®
- etcdï¼šè‡ªå®šä¹‰åç§°ï¼Œè¡¨ç¤ºæ˜¯etcdé›†ç¾¤éœ€è¦çš„ç­¾åé…ç½®
- expiryï¼šè¯ä¹¦æœ‰æ•ˆæœŸ
- usagesï¼šç”¨äºè¯ä¹¦çš„ä½¿ç”¨åœºæ™¯ï¼Œå¸¸ç”¨å€¼å¦‚ä¸‹ï¼š
-signingï¼šå…è®¸è¯ä¹¦ç”¨äºç­¾åã€‚
-key enciphermentï¼šå…è®¸è¯ä¹¦ç”¨äºå¯†é’¥åŠ å¯†ï¼ˆTLS æ¡æ‰‹ä¸­ä½¿ç”¨ï¼‰ã€‚
-server authï¼šå…è®¸è¯ä¹¦ç”¨äºæœåŠ¡å™¨è®¤è¯
-client authï¼šå…è®¸è¯ä¹¦ç”¨äºå®¢æˆ·ç«¯è®¤è¯

```shell
cat > ca-csr.json << EOF
{
  "CN": "etcd-ca",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "Beijing",
      "O": "etcd",
      "OU": "CA",
      "ST": "Beijing"
    }
  ]
}
EOF
```
å‚æ•°è§£æï¼š
- C (Country): "CN"
    - è¡¨ç¤ºå›½å®¶ä»£ç ï¼Œè¿™é‡Œæ˜¯â€œä¸­å›½â€ã€‚
- ST (State or Province): "Beijing"
    - è¡¨ç¤ºå·æˆ–çœä»½ï¼Œè¿™é‡Œæ˜¯â€œåŒ—äº¬â€ã€‚
- L (Locality): "Beijing"
    - è¡¨ç¤ºåŸå¸‚æˆ–åœ°åŒºï¼Œè¿™é‡Œä¹Ÿæ˜¯â€œåŒ—äº¬â€ã€‚
- O (Organization): "etcd"
    - è¡¨ç¤ºç»„ç»‡åç§°ï¼Œè¿™é‡Œä½¿ç”¨â€œetcdâ€ï¼Œå¯èƒ½ä»£è¡¨ etcd é›†ç¾¤æˆ–ç›¸å…³ç»„ç»‡ã€‚
- OU (Organizational Unit): "CA"
    - è¡¨ç¤ºç»„ç»‡å•ä½ï¼Œè¿™é‡Œæ˜¯â€œCAâ€ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªè¯ä¹¦é¢å‘æœºæ„çš„è¯ä¹¦ã€‚
è¿™äº›å­—æ®µæœ¬èº«ä¸ç›´æ¥ä¸æƒé™æŒ‚é’©ï¼Œä½†æŸäº›å­—æ®µï¼ˆå¦‚ CN å’Œ Oï¼‰å¯èƒ½è¢« Kubernetes çš„è®¤è¯å’Œæˆæƒæœºåˆ¶é—´æ¥ä½¿ç”¨ã€‚
##### CN å’Œ O åœ¨ RBAC ä¸­çš„ä½œç”¨
- CNï¼ˆCommon Nameï¼‰ï¼š
    - åœ¨ Kubernetes ä¸­ï¼Œè¯ä¹¦çš„ CN é€šå¸¸è¢«ç”¨ä½œç”¨æˆ·çš„ç”¨æˆ·åï¼ˆUser Nameï¼‰ã€‚
    - ä¾‹å¦‚ï¼Œå¦‚æœè¯ä¹¦çš„ CN æ˜¯ admin-userï¼ŒKubernetes ä¼šå°†è¯¥è¯ä¹¦çš„æŒæœ‰è€…è§†ä¸ºç”¨æˆ· admin-userï¼Œå¹¶æ ¹æ® RBACï¼ˆRole-Based Access Controlï¼‰è§„åˆ™æ£€æŸ¥è¯¥ç”¨æˆ·çš„æƒé™ã€‚
- Oï¼ˆOrganizationï¼‰ï¼š
    - O å­—æ®µè¢«ç”¨ä½œç”¨æˆ·çš„ç»„ï¼ˆGroupï¼‰ã€‚
    - ä¾‹å¦‚ï¼Œå¦‚æœè¯ä¹¦çš„ O æ˜¯ system:mastersï¼ŒKubernetes ä¼šå°†è¯¥ç”¨æˆ·è¯†åˆ«ä¸º system:masters ç»„çš„æˆå‘˜ã€‚system:masters æ˜¯ä¸€ä¸ªå†…ç½®çš„è¶…çº§ç®¡ç†å‘˜ç»„ï¼Œé€šå¸¸å…·æœ‰é›†ç¾¤çš„å®Œå…¨æ§åˆ¶æƒé™ã€‚
- é€šè¿‡åœ¨ RBAC è§„åˆ™ä¸­ä¸ºç‰¹å®šçš„ Userï¼ˆCNï¼‰æˆ– Groupï¼ˆOï¼‰åˆ†é… Role æˆ– ClusterRoleï¼Œå¯ä»¥æ§åˆ¶æƒé™ã€‚
##### RBAC é…ç½®
- Kubernetes çš„æƒé™é€šè¿‡ RBAC è§„åˆ™å®šä¹‰ï¼Œç»‘å®šåˆ°ç”¨æˆ·ï¼ˆCNï¼‰æˆ–ç»„ï¼ˆOï¼‰ã€‚
- ä¾‹å¦‚ï¼Œé›†ç¾¤ç®¡ç†å‘˜å¯èƒ½åˆ›å»ºä¸€ä¸ª ClusterRoleBindingï¼š
    ```yaml
    apiVersion: rbac.authorization.k8s.io/v1
    kind: ClusterRoleBinding
    metadata:
      name: admin-binding
    subjects:
    - kind: User
      name: admin-user  # å¯¹åº”è¯ä¹¦çš„ CN
      apiGroup: rbac.authorization.k8s.io
    - kind: Group
      name: system:masters  # å¯¹åº”è¯ä¹¦çš„ O
      apiGroup: rbac.authorization.k8s.io
    roleRef:
      kind: ClusterRole
      name: cluster-admin
      apiGroup: rbac.authorization.k8s.io
    ```
- åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒCN=admin-user æˆ– O=system:masters çš„è¯ä¹¦æŒæœ‰è€…å°†è·å¾— cluster-admin æƒé™ã€‚
c. è¯ä¹¦çš„ç”¨é€”å’Œä¸Šä¸‹æ–‡
- è¯ä¹¦çš„æƒé™è¿˜å–å†³äºå®ƒåœ¨ Kubernetes ä¸­çš„ä½¿ç”¨åœºæ™¯ã€‚ä¾‹å¦‚ï¼š
    - CA è¯ä¹¦ï¼ˆå¦‚ CN=kubernetes-caï¼‰ï¼šé€šå¸¸ä¸ç›´æ¥ç”¨äºæƒé™ï¼Œè€Œæ˜¯ç”¨äºç­¾ç½²å…¶ä»–è¯ä¹¦ï¼ˆå¦‚ API Serverã€etcdã€å®¢æˆ·ç«¯è¯ä¹¦ï¼‰ã€‚
    - å®¢æˆ·ç«¯è¯ä¹¦ï¼šç”¨äºè®¤è¯ç”¨æˆ·æˆ–ç»„ä»¶ï¼ŒCN å’Œ O å†³å®šå…¶èº«ä»½å’Œç»„å½’å±ã€‚
    - æœåŠ¡ç«¯è¯ä¹¦ï¼šå¦‚ API Server è¯ä¹¦ï¼Œé€šå¸¸ä¸æ¶‰åŠ RBAC æƒé™ï¼Œè€Œæ˜¯ç”¨äº TLS é€šä¿¡ã€‚

==ç”ŸæˆCAè¯ä¹¦ï¼š==
```shell
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
```
ä¼šç”Ÿæˆä»¥ä¸‹3ä¸ªæ–‡ä»¶ï¼š
- `ca.pem`ï¼ˆæ ¹è¯ä¹¦ï¼‰
- `ca-key.pem`ï¼ˆæ ¹ç§é’¥ï¼‰
- `ca.csr`ï¼ˆè¯·æ±‚æ–‡ä»¶ï¼‰

##### 2.2.2.2ï¼Œç”ŸæˆETCDçš„serverè¯ä¹¦
==åˆ›å»ºetcdçš„crsæ–‡ä»¶==
ä¸€èˆ¬æƒ…å†µæ‰€æœ‰etcdèŠ‚ç‚¹å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¯ä¹¦ã€‚å®‰å…¨è€ƒè™‘çš„è¯å¯ä»¥ä¸ºæ¯ä¸ªèŠ‚ç‚¹çš„etcdå•ç‹¬ç”Ÿæˆè¯ä¹¦ï¼Œhostå¡«å†™å¯¹äºèŠ‚ç‚¹ä¿¡æ¯å³å¯ã€‚è¿™é‡Œ3ä¸ªèŠ‚ç‚¹ä½¿ç”¨ç›¸åŒè¯ä¹¦ã€‚
```shell
cat > etcd-csr.json << EOF
{
  "CN": "etcd",
  "hosts": [
    "127.0.0.1",
    "192.168.0.111",
    "192.168.0.112",
    "192.168.0.113",
    "test-master-01",
    "test-master-02",
    "test-master-03",
    "localhost"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Server",
      "ST": "Beijing"
    }
  ]
}
EOF
```
å‚æ•°è§£æï¼š
- hostï¼šè¯ä¹¦æ”¯æŒçš„ä¸»æœºåå’Œ IP åˆ—è¡¨ï¼ˆSubject Alternative Name, SANï¼‰ï¼Œç”¨äº TLS ä¸»æœºéªŒè¯ã€‚
==ç”ŸæˆetcdæœåŠ¡ç«¯è¯ä¹¦==
```shell
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  etcd-csr.json | cfssljson -bare etcd
```
ç”Ÿæˆï¼š
etcd.pem
etcd-key.pem
##### 2.2.2.3ï¼Œç”ŸæˆETCDçš„èŠ‚ç‚¹é—´è¯ä¹¦
==åˆ›å»ºèŠ‚ç‚¹é—´é€šä¿¡ CSR é…ç½®æ–‡ä»¶==
```shell
cat > peer-csr.json << EOF
{
  "CN": "etcd-peer",
  "hosts": [
    "127.0.0.1",
    "192.168.0.111",
    "192.168.0.112",
    "192.168.0.113",
    "test-master-01",
    "test-master-02",
    "test-master-03",
    "localhost",
    "etcd",
    "etcd.default.svc",
    "etcd.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Server",
      "ST": "Beijing"
    }
  ]
}
EOF
```

==ç”ŸæˆèŠ‚ç‚¹é—´é€šä¿¡è¯ä¹¦å’Œç§é’¥==
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  peer-csr.json | cfssljson -bare peer
```
ç”Ÿæˆï¼š
peer.pem
peer-key.pem
##### 2.2.2.4ï¼Œç”ŸæˆETCDçš„å®¢æˆ·ç«¯è¯ä¹¦
==åˆ›å»ºå®¢æˆ·ç«¯ CSR é…ç½®æ–‡ä»¶==
```shell
cat > etcd-client-csr.json << EOF
{
  "CN": "apiserver-etcd-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "L": "Beijing",
      "O": "etcd",
      "OU": "Server",
      "ST": "Beijing"
    }
  ]
}
EOF
```

==ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥==
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  etcd-client-csr.json | cfssljson -bare etcd-client
```
ç”Ÿæˆï¼š
etcd-client.pem
etcd-client-key.pem

##### 2.2.2.5ï¼Œç”ŸæˆETCDçš„apiserver-clientè¯ä¹¦
åˆ›å»ºCSRé…ç½®æ–‡ä»¶
```bash
cat > apiserver-etcd-csr.json << EOF
{
  "CN": "kube-apiserver-etcd-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",
      "OU": "Kubernetes"
    }
  ]
}
EOF
```

ç”Ÿæˆapiserver-etcdè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=etcd \
  apiserver-etcd-csr.json | cfssljson -bare apiserver-etcd
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp apiserver-etcd*.pem 192.168.0.112:/etc/kubernetes/pki/etcd/
```

---
#### ç”Ÿæˆkubernetesæ§åˆ¶é¢ç›¸å…³ç»„ä»¶çš„è¯ä¹¦
è¿™éƒ¨åˆ†ä½¿ç”¨ç‹¬ç«‹çš„caè¯ä¹¦æ¥ç­¾å‘ç›¸å…³è¯ä¹¦ã€‚

==ç”ŸæˆCAæ ¹è¯ä¹¦==
åˆ›å»º CA é…ç½®æ–‡ä»¶ï¼š
```shell
cat > ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}
EOF
```

åˆ›å»º CA è¯ä¹¦ç­¾åè¯·æ±‚ï¼š
```shell
cat > ca-csr.json << EOF
{
  "CN": "kubernetes-ca",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "CA"
    }
  ]
}
EOF
```

ç”ŸæˆCAæ ¹è¯ä¹¦ï¼š
```bash
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰èŠ‚ç‚¹
```bash
cp ca*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes
```
#### 2.2.3ï¼Œç”Ÿæˆkubeletè¯ä¹¦
kubeletè¯ä¹¦åˆ†ä¸ºclientå’Œserverè¯ä¹¦ï¼š
- clientè¯ä¹¦æ˜¯æ¯ä¸ªèŠ‚ç‚¹çš„kubeletä½œä¸ºå®¢æˆ·ç«¯å»è¯·æ±‚apiserveræ—¶ï¼ŒåŒæ–¹çš„èº«ä»½éªŒè¯ã€‚
- serverè¯ä¹¦æ˜¯ç”¨äº kubelet çš„ HTTPS ç«¯ç‚¹ï¼ˆå¦‚ 10250 ç«¯å£ï¼‰ï¼Œä¾› API Server æˆ–å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ kube-proxy æˆ–ç›‘æ§å·¥å…·ï¼‰è®¿é—® kubelet çš„ APIã€‚
- apiserver-kubelet-clientï¼šé…ç½®åœ¨apiserverçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œæ˜¯kubeletå’Œapiserveré—´çš„é€šä¿¡éªŒè¯

##### 2.2.3.1ï¼Œclientè¯ä¹¦
åˆ›å»ºkubeletçš„crsæ–‡ä»¶ï¼Œéœ€è¦åˆ†åˆ«åˆ›å»ºæ¯ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦ã€‚
```shell
#masterèŠ‚ç‚¹çš„kubelet
cat > kubelet-client-master3-csr.json << EOF
{
  "CN": "system:node:test-master-03",
  "hosts": [
    "127.0.0.1",
    "192.168.0.113",
    "test-master-03",
    "localhost"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:nodes",
    "OU": "Kubernetes"
  }]
}
EOF
```

```shell
#nodeèŠ‚ç‚¹çš„kubelet
cat > kubelet-client-node1-csr.json << EOF
{
  "CN": "system:node:test-node-01",
  "hosts": [
    "127.0.0.1",
    "192.168.0.114",
    "test-node-01",
    "localhost"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:nodes",
    "OU": "Kubernetes"
  }]
}
EOF
```

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kubelet-client-master3-csr.json | cfssljson -bare kubelet-client-master3
```

##### 2.2.3.2ï¼Œserverè¯ä¹¦
åˆ›å»ºkubeletçš„crsæ–‡ä»¶ï¼Œéœ€è¦åˆ†åˆ«åˆ›å»ºæ¯ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦ã€‚
```shell
#masterèŠ‚ç‚¹çš„kubelet
cat > kubelet-server-master1-csr.json << EOF
{
  "CN": "test-master-01",
  "hosts": [
    "127.0.0.1",
    "192.168.0.111",
    "test-master-01",
    "localhost"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "Kubernetes",
    "OU": "Node"
  }]
}
EOF
```

```shell
#nodeèŠ‚ç‚¹çš„kubelet
cat > kubelet-server-node1-csr.json << EOF
{
  "CN": "test-node-01",
  "hosts": [
    "127.0.0.1",
    "192.168.0.114",
    "test-node-01",
    "localhost"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "Kubernetes",
    "OU": "Node"
  }]
}
EOF
```


```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kubelet-server-node1-csr.json | cfssljson -bare kubelet-server-node1
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼š
```bash
scp kubelet-*master2*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes
```

##### 2.2.3.3ï¼Œç”Ÿæˆapiserver-kubeletè¯ä¹¦
åˆ›å»ºç”Ÿæˆ API Server Kubeletçš„csræ–‡ä»¶
```bash
cat > apiserver-kubelet-csr.json << EOF
{
  "CN": "kube-apiserver-kubelet-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "system:masters",
      "OU": "Kubernetes"
    }
  ]
}
EOF
```
ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  apiserver-kubelet-csr.json | cfssljson -bare apiserver-kubelet-client
```
å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp apiserver-kubelet-c*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes/
```


#### 2.2.4ï¼Œç”Ÿæˆapiserverç»„ä»¶ç›¸å…³è¯ä¹¦

- apiserverï¼škube-apiserverå’Œå…¶ä»–ç»„ä»¶é€šä¿¡çš„éªŒè¯
##### 2.2.4.1ï¼Œç”Ÿæˆapiserverè¯ä¹¦
åˆ›å»ºapiserverçš„csræ–‡ä»¶
```shell
cat > apiserver-csr.json << EOF
{
  "CN": "kube-apiserver",
  "hosts": [
    "127.0.0.1",
    "10.233.0.1",
    "192.168.0.111",
    "192.168.0.112",
    "192.168.0.113",
    "test-master-01",
    "test-master-02",
    "test-master-03",
    "localhost",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.cluster.local"
  ],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "Kubernetes",
    "OU": "API Server"
  }]
}
EOF
```
å‚æ•°è§£æï¼š
- hostsï¼šæ˜¯å…¶ä»–ä»»ä½•ç»„ä»¶æˆ–å®¢æˆ·ç«¯å»è®¿é—®kube-apiserveræ—¶ï¼Œè¿æ¥çš„åœ°å€å¿…é¡»è¦åŒ…å«åœ¨hostså†…ï¼Œapiserverä¼šå¯¹è¯ä¹¦çš„hostsï¼ˆå³SANsï¼‰è¿›è¡Œæ ¡éªŒã€‚å¦‚æœæœ‰haé«˜å¯ç”¨çš„vipï¼Œè¿™é‡Œä¹Ÿå¯ä»¥åŠ ä¸Švipçš„åœ°å€ã€‚
- `10.233.0.1`æ˜¯çš„ Kubernetes ï¼ˆkube-apiserverï¼‰çš„æœåŠ¡ IPï¼Œè‹¥é›†ç¾¤ä½¿ç”¨è‡ªå®šä¹‰æœåŠ¡ CIDRï¼Œè¯·ç›¸åº”è°ƒæ•´ã€‚é»˜è®¤æ˜¯`10.96.0.1` ã€‚
æŸ¥è¯¢å¦‚ä¸‹ï¼š
![[Pasted image 20250528113714.png]]

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  apiserver-csr.json | cfssljson -bare apiserver
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp apiserver*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes/
```

#### 2.2.5ï¼Œadminè¯ä¹¦
åˆ›å»º ç®¡ç†å‘˜adminçš„csræ–‡ä»¶
```shell
cat > admin-csr.json << EOF
{
  "CN": "admin",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:masters",
    "OU": "Kubernetes"
  }]
}
EOF
```

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  admin-csr.json | cfssljson -bare admin
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp admin*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes/
```

#### 2.2.6ï¼Œcontroller-managerè¯ä¹¦
åˆ›å»ºcontroller-managerçš„csræ–‡ä»¶
```shell
cat > controller-manager-csr.json << EOF
{
  "CN": "system:kube-controller-manager",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:kube-controller-manager",
    "OU": "Kubernetes"
  }]
}
EOF
```

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  controller-manager-csr.json | cfssljson -bare controller-manager
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp controller-manager*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes/
```

#### 2.2.7ï¼Œschedulerè¯ä¹¦
åˆ›å»ºschedulerçš„csræ–‡ä»¶
```shell
cat > scheduler-csr.json << EOF
{
  "CN": "system:kube-scheduler",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:kube-scheduler",
    "OU": "Kubernetes"
  }]
}
EOF
```

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  scheduler-csr.json | cfssljson -bare scheduler
```

å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp scheduler*.pem 192.168.0.112:/etc/kubernetes/pki/kubernetes/
```


#### 2.2.8ï¼Œkube-proxyè¯ä¹¦
åˆ›å»ºkube-proxyçš„csræ–‡ä»¶
```shell
cat > kube-proxy-csr.json << EOF
{
  "CN": "system:kube-proxy",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [{
    "C": "CN",
    "ST": "Beijing",
    "L": "Beijing",
    "O": "system:kube-proxy",
    "OU": "Kubernetes"
  }]
}
EOF
```

ç”Ÿæˆè¯ä¹¦
```bash
cfssl gencert \
  -ca=ca.pem \
  -ca-key=ca-key.pem \
  -config=ca-config.json \
  -profile=kubernetes \
  kube-proxy-csr.json | cfssljson -bare kube-proxy
```

```bash
mv kube-proxy*.pem /etc/kubernetes/pki/kubernetes/
```
æ­¤è¯ä¹¦ä¸éœ€è¦å…¶ä»–èŠ‚ç‚¹ä½¿ç”¨ï¼Œåé¢æ­¥éª¤åœ¨éƒ¨ç½²kube-proxyæ—¶ï¼Œåˆ›å»ºkubeconfigä½¿ç”¨

#### 2.2.8ï¼Œç”Ÿæˆå‰ç«¯ä»£ç†è¯ä¹¦
ç”¨äºæ”¯æŒæ‰©å±• API Server çš„èšåˆå±‚ï¼Œä½¿ç”¨å•ç‹¬çš„CAæ ¹è¯ä¹¦ç­¾å‘

åˆ›å»ºCAè¯ä¹¦

```bash
cat > front-proxy-ca-config.json << EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
          "signing",
          "key encipherment",
          "server auth",
          "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}
EOF
```

```bash
cat > front-proxy-ca-csr.json << EOF
{
  "CN": "kubernetes-front-proxy-ca",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Front Proxy CA"
    }
  ]
}
EOF
```
ç”ŸæˆCAè¯ä¹¦
```bash
cfssl gencert -initca front-proxy-ca-csr.json | cfssljson -bare front-proxy-ca
```

åˆ›å»ºå‰ç«¯ä»£ç†å®¢æˆ·ç«¯ CSR
```bash
cat > front-proxy-client-csr.json << EOF
{
  "CN": "front-proxy-client",
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "Beijing",
      "L": "Beijing",
      "O": "Kubernetes",
      "OU": "Front Proxy"
    }
  ]
}
EOF
```

ç”Ÿæˆfront-proxyè¯ä¹¦
```bash
cfssl gencert \
  -ca=front-proxy-ca.pem \
  -ca-key=front-proxy-ca-key.pem \
  -config=front-proxy-ca-config.json \
  -profile=kubernetes \
  front-proxy-client-csr.json | cfssljson -bare front-proxy-client
```
å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp front-proxy-*.pem 192.168.0.113:/etc/kubernetes/pki/front-proxy/
```
#### 2.2.9ï¼Œç”Ÿæˆ Service Account å¯†é’¥
ä½¿ç”¨opensslåˆ›å»ºsa.keyå’Œsa.pubï¼Œåœ¨ Kubernetes ä¸­ï¼Œ`sa.key` å’Œ `sa.pub` æ˜¯ç”¨äº **ServiceAccount Token ç­¾åä¸éªŒè¯** çš„ RSA å¯†é’¥å¯¹ã€‚æ§åˆ¶å¹³é¢ä½¿ç”¨ `sa.key` æ¥ç­¾å‘ Tokenï¼Œç»„ä»¶ç”¨ `sa.pub` æ¥éªŒè¯å®ƒã€‚

ç”Ÿæˆ RSA å¯†é’¥å¯¹
```bash
openssl genrsa -out sa.key 2048
openssl rsa -in sa.key -pubout -out sa.pub
```
å¤åˆ¶è¯ä¹¦åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp sa*  192.168.0.112:/etc/kubernetes/pki/sa/
```

### 2.3ï¼Œå®‰è£…etcd

#### 2.3.1å¼€å§‹å®‰è£…é…ç½®etcd
==masterèŠ‚ç‚¹==
etcdå¯ä½¿ç”¨systemdå’Œå®¹å™¨ä¸¤ç§æ–¹å¼å®‰è£…ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæ¨èä½¿ç”¨systemdã€‚
ä¸‹è½½ï¼šhttps://github.com/etcd-io/etcd/releases/download/v3.5.15/etcd-v3.5.15-linux-amd64.tar.gz
`wget https://github.com/etcd-io/etcd/releases/download/v3.5.15/etcd-v3.5.15-linux-amd64.tar.gz`

è§£å‹&&ç§»åŠ¨
```shell
tar -xzf etcd-v3.5.15-linux-amd64.tar.gz
mv etcd-v3.5.15-linux-amd64/etcd etcd-v3.5.15-linux-amd64/etcdctl /usr/local/bin
```

#### 2.2.3ï¼Œé…ç½®etcdæœåŠ¡
åˆ›å»ºetcdæ•°æ®ç›®å½•å’Œé…ç½®ç›®å½•
`mkdir -p /var/lib/etcd`
`mkdir -p /etc/etcd/etcd.d`

ç”Ÿæˆetcdçš„systemdçš„å¯åŠ¨ç¯å¢ƒå˜é‡
```shell
cat > /etc/etcd/etcd.d/etcd.env << EOF
ETCD_NAME=etcd-k8s-master-03
ETCD_DATA_DIR=/var/lib/etcd

ETCD_INITIAL_ADVERTISE_PEER_URLS=https://192.168.0.113:2380
ETCD_ADVERTISE_CLIENT_URLS=https://192.168.0.113:2379
ETCD_LISTEN_PEER_URLS=https://192.168.0.113:2380
ETCD_LISTEN_CLIENT_URLS=https://192.168.0.113:2379,https://127.0.0.1:2379

ETCD_INITIAL_CLUSTER_TOKEN=k8s_etcd
ETCD_INITIAL_CLUSTER_STATE=new
ETCD_INITIAL_CLUSTER="etcd-k8s-master-01=https://192.168.0.111:2380,etcd-k8s-master-02=https://192.168.0.112:2380,etcd-k8s-master-03=https://192.168.0.113:2380"

ETCD_METRICS=basic
ETCD_ELECTION_TIMEOUT=5000
ETCD_HEARTBEAT_INTERVAL=250
ETCD_AUTO_COMPACTION_RETENTION=8
ETCD_SNAPSHOT_COUNT=10000

# TLS é…ç½®
ETCD_TRUSTED_CA_FILE=/etc/etcd/pki/ca.pem
ETCD_CERT_FILE=/etc/etcd/pki/etcd.pem
ETCD_KEY_FILE=/etc/etcd/pki/etcd-key.pem
ETCD_CLIENT_CERT_AUTH=true

ETCD_PEER_TRUSTED_CA_FILE=/etc/etcd/pki/ca.pem
ETCD_PEER_CERT_FILE=/etc/etcd/pki/etcd.pem
ETCD_PEER_KEY_FILE=/etc/etcd/pki/etcd-key.pem
ETCD_PEER_CLIENT_CERT_AUTH=true

# etcdctl é»˜è®¤é…ç½®
ETCDCTL_ENDPOINTS=https://127.0.0.1:2379
ETCDCTL_CACERT=/etc/etcd/pki/ca.pem
ETCDCTL_CERT=/etc/etcd/pki/admin.pem
ETCDCTL_KEY=/etc/etcd/pki/admin-key.pem
EOF
```

==å‚æ•°è§£æ==
- ETCD_INITIAL_CLUSTER_STATEï¼šnew/existing
newï¼šä¸€èˆ¬ç”¨äºé›†ç¾¤åˆå§‹åŒ–ï¼Œæ–°é›†ç¾¤åˆ›å»ºæ—¶
existingï¼šç”¨äºåŠ å…¥å·²æœ‰é›†ç¾¤ï¼Œå¦‚æ·»åŠ æ–°çš„èŠ‚ç‚¹

åˆ›å»ºsystemd.service
```shell
cat > /etc/systemd/system/etcd.service << EOF
[Unit]
Description=etcd
After=network.target

[Service]
User=root
Type=notify
Nice=-20
OOMScoreAdjust=-1000
EnvironmentFile=/etc/etcd/etcd.d/etcd.env
ExecStart=/usr/local/bin/etcd
NotifyAccess=all
RestartSec=10s
LimitNOFILE=40000
Restart=always

[Install]
WantedBy=multi-user.target
EOF
```

æ·»åŠ å¼€æœºå¯åŠ¨&&å¯åŠ¨æœåŠ¡
`systemctl enable etcd && systemctl start etcd`

é…ç½®etcdèŠ‚ç‚¹çš„etcdctlç¯å¢ƒå˜é‡
```bash
cat >> ~/.bashrc <<EOF
export ETCDCTL_API=3
export ETCDCTL_ENDPOINTS="https://127.0.0.1:2379"
export ETCDCTL_CACERT="/etc/etcd/pki/ca.pem"
export ETCDCTL_CERT="/etc/etcd/pki/admin.pem"
export ETCDCTL_KEY="/etc/etcd/pki/admin-key.pem"
EOF
```

ç”Ÿæ•ˆç¯å¢ƒå˜é‡
`source ~/.bashrc`

å¸¸ç”¨å‘½ä»¤ï¼š
```shell
# æŸ¥è¯¢é›†ç¾¤å¥åº·çŠ¶æ€
etcdctl endpoint health --cluster --write-out=table
# æŸ¥è¯¢é›†ç¾¤çŠ¶æ€,è¿™é‡Œçš„â€œIS LEADERâ€å°±æ˜¯å½“å‰é›†ç¾¤çš„leaderèŠ‚ç‚¹
etcdctl endpoint status --cluster --write-out=table
# æŸ¥è¯¢é›†ç¾¤æˆå‘˜
etcdctl member list --write-out=table


```

å°è®°ï¼š
```txt
# 3ä¸ªé›†ç¾¤éœ€è¦ä¸€èµ·å¯åŠ¨ï¼Œå› ä¸ºå¯åŠ¨çš„ç¯å¢ƒå˜é‡æ·»åŠ äº†é›†ç¾¤çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œä¼šè‡ªåŠ¨ç›‘å¬æ¯ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ã€‚ä»»æ„èŠ‚ç‚¹æ‰çº¿ä¼šåœ¨å…¶ä½™æ­£å¸¸èŠ‚ç‚¹çš„æ—¥å¿—ä¸­æŸ¥çœ‹åˆ°è®°å½•
```

etcdæ‹“å±•ï¼š
#### 001ï¼Œæ•°æ®æ¢å¤
##### ==åœºæ™¯1ï¼šetcdé›†ç¾¤å…¨éƒ¨èŠ‚ç‚¹ä¸å¯ç”¨==
(ä½¿ç”¨åŒä¸€å¿«ç…§æ–‡ä»¶æ¢å¤å…¨éƒ¨èŠ‚ç‚¹ï¼Œæ­¤æ–¹æ³•å·²å¤šæ¬¡éªŒè¯)
å‰æï¼š
- è¿™ç§æƒ…å†µå±äºç¾éš¾æ¢å¤ï¼Œk8så·²ç»ä¸å¯ä½¿ç”¨
- æœ‰å¼‚å¸¸å‰çš„å¤‡ä»½
- æ¢å¤åï¼Œåœ¨å¤‡ä»½åˆ°å¼‚å¸¸å‡ºç°çš„æ—¶é—´åŒºé—´å†…ï¼Œå¦‚æœæœ‰æ•°æ®å†™å…¥ä¼šä¸¢å¤±è¿™éƒ¨åˆ†æ•°æ®
æ­¥éª¤ï¼š
```shell
#æ ¡éªŒæ•°æ®æ–‡ä»¶
etcdctl snapshot status etcd-0956.db
#é¢„æœŸè¾“å‡ºç±»ä¼¼ï¼š
Hash: 12345678, Revision: 1000, Total Keys: 500, Total Size: 12 MB
#ä¼ è¾“æ­¤å¤‡ä»½åˆ°æ‰€æœ‰èŠ‚ç‚¹
scp *.db etcd-node-*:/path

#åœæ­¢æ‰€æœ‰etcdæœåŠ¡
systemctl stop etcd

#éªŒè¯æœåŠ¡çŠ¶æ€
systemctl status etcd

#æ¸…ç†æ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ç›®å½•
rm -rf /var/lib/etcd/*

#ç¡®è®¤æ•°æ®ç›®å½•ä¸ºç©º
ls -l /var/lib/etcd

#ç¡®è®¤æ•°æ®ç›®å½•æƒé™
user:rootæˆ–etcd
æƒé™ï¼š700

#ä½¿ç”¨å¤‡ä»½æ¢å¤åˆ°æ¯ä¸ªetcdèŠ‚ç‚¹
#ä¸‹é¢çš„å‘½ä»¤éœ€è¦åœ¨3ä¸ªèŠ‚ç‚¹åˆ†åˆ«æ‰§è¡Œï¼Œä¸åŒèŠ‚ç‚¹æ›¿æ¢å…¶ä¸­nameã€initial-advertise-peer-urlså³å¯
ETCDCTL_API=3 etcdctl snapshot restore /root/etcd-1119.db  \
  --cacert=/etc/etcd/pki/ca.pem \
  --cert=/etc/etcd/pki/admin.pem \
  --key=/etc/etcd/pki/admin-key.pem  \
  --name etcd-k8s-master-01  \
  --initial-cluster etcd-k8s-master-01=https://192.168.0.111:2380,etcd-k8s-master-02=https://192.168.0.112:2380,etcd-k8s-master-03=https://192.168.0.113:2380  \
  --initial-cluster-token k8s_etcd  \
  --initial-advertise-peer-urls https://192.168.0.111:2380  \
  --data-dir /var/lib/etcd
#ä¸Šé¢çš„å‚æ•°å€¼ï¼Œå¯é€šè¿‡systemdçš„serviceå†…å®¹è·å–
```
èŠ‚ç‚¹æ‰§è¡Œæ¢å¤å¤‡ä»½è¾“å‡ºå¦‚å›¾ï¼š
![[Pasted image 20250515103855.png]]
```shell
#éªŒè¯æ¢å¤ç»“æœï¼ŒæŸ¥çœ‹æ˜¯å¦å·²ç»ç”Ÿæˆæ•°æ®
ls -l /var/lib/etcd

#ç¡®å®šæ˜¯å¦å˜æ›´äº†systemdçš„é…ç½®æ–‡ä»¶ï¼Œå¦‚æœæœ‰åˆ™éœ€è¦å¯¹åº”ä¿®æ”¹å…¶å‚æ•°ï¼Œå¹¶é‡æ–°åŠ è½½é…ç½®ï¼Œæ²¡æœ‰åˆ™å¿½ç•¥ã€‚

#æ³¨æ„ï¼šETCD_INITIAL_CLUSTER_STATEçš„å€¼ä¿æŒä¸ºï¼šnewï¼Œå› ä¸ºå¤‡ä»½ç›¸å½“äºé‡å»º
ETCD_INITIAL_CLUSTER_STATE=new

#åˆ†åˆ«å¯åŠ¨æ‰€ä»¥etcdæœåŠ¡
systemctl start etcd

#æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
etcdctl endpoint health --cluster
#è¾“å‡ºï¼š
https://192.168.0.113:2379 is healthy: successfully committed proposal: took = 12.826706ms
https://192.168.0.112:2379 is healthy: successfully committed proposal: took = 15.380707ms
https://192.168.0.111:2379 is healthy: successfully committed proposal: took = 17.691775ms
```

##### ==åœºæ™¯2ï¼šetcdé›†ç¾¤1ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨==
æ–¹æ³•ä¸€ï¼šä½¿ç”¨ä»»ä½•å¤‡ä»½æ–‡ä»¶æ¢å¤å¼‚å¸¸èŠ‚ç‚¹ï¼Œæ­¤æ–¹æ³•æœªéªŒè¯æˆåŠŸ
å‰æï¼š
- ä»…ä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨ï¼Œ3èŠ‚ç‚¹çš„é«˜å¯ç”¨é›†ç¾¤ï¼Œæ³•å®šå¯ç”¨èŠ‚ç‚¹ä¸º2ä¸ªä¸å½±å“é›†ç¾¤ï¼Œk8sé›†ç¾¤ä¹Ÿä¸å½±å“ã€‚
- æœ‰å¼‚å¸¸å‰çš„å¤‡ä»½ï¼Œæˆ–è€…é€šè¿‡æ­£å¸¸èŠ‚ç‚¹ç«‹å³å¤‡ä»½ï¼Œæˆ–ä½¿ç”¨æ­£å¸¸èŠ‚ç‚¹çš„æ•°æ®æ‹·è´æ¥æ¢å¤

æ­¥éª¤ï¼š
```shell

systemctl stop etcd

rm -rf /var/lib/etcd/*

ETCDCTL_API=3 etcdctl snapshot restore /root/etcd-1355.db \
  --name etcd-k8s-master-02 \
  --data-dir /var/lib/etcd \
  --initial-cluster etcd-k8s-master-01=https://192.168.0.111:2380,etcd-k8s-master-02=https://192.168.0.112:2380,etcd-k8s-master-03=https://192.168.0.113:2380 \
  --initial-cluster-token k8s_etcd \
  --initial-advertise-peer-urls https://192.168.0.112:2380


ETCD_INITIAL_CLUSTER_STATE=existing

systemctl start etcd
```

æ–¹æ³•äºŒï¼šåˆ é™¤èŠ‚ç‚¹é‡æ–°åŠ å…¥é›†ç¾¤ï¼Œæ­¤æ–¹æ³•å·²ç»è¿‡å¤šæ¬¡éªŒè¯
å‰æï¼š
- è‡³å°‘æœ‰2ä¸ªèŠ‚ç‚¹æ­£å¸¸
æ­¥éª¤ï¼š
```shell
#åœ¨æ­£å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼ŒæŸ¥è¯¢é›†ç¾¤åˆ—è¡¨ï¼Œè®°å½•å¼‚å¸¸èŠ‚ç‚¹çš„id
etcdctl member list

#åœ¨æ­£å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼Œåˆ é™¤å¼‚å¸¸èŠ‚ç‚¹,åˆ é™¤åå†æ¬¡æŸ¥è¯¢é›†ç¾¤åˆ—è¡¨ç¡®è®¤åˆ é™¤æˆåŠŸ
etcdctl member remove 54891d878459d711

#åœ¨å¼‚å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼Œåœæ­¢etcd
systemctl stop etcd

#åœ¨å¼‚å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼Œåˆ é™¤æˆ–å¤‡ä»½æ•°æ®ç›®å½•
mv /var/lib/etcd /var/lib/etcd.bak
æˆ–è€…
rm -rf /var/lib/etcd/*

#åœ¨æ­£å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼Œæ·»åŠ èŠ‚ç‚¹,ä»¥ä¸‹å‘½ä»¤çš„å‰ææ˜¯ç¯å¢ƒå˜é‡å·²é…ç½®etcdå®¢æˆ·ç«¯è¯ä¹¦å’ŒendpointåŠetcd_apiç‰ˆæœ¬ï¼Œä¸ç„¶éœ€è¦åœ¨ä»¥ä¸‹å‘½ä»¤ä¸­æ·»åŠ è¿™äº›å‚æ•°
etcdctl member add etcd-k8s-master-01 \
  --peer-urls=https://192.168.0.111:2380

#æ‰§è¡Œåè¾“å‡ºå¦‚ä¸‹ï¼š
ETCD_NAME="etcd-k8s-master-02"
ETCD_INITIAL_CLUSTER="etcd-k8s-master-01=https://192.168.0.111:2380,etcd-k8s-master-03=https://192.168.0.113:2380,etcd-k8s-master-02=https://192.168.0.112:2380"
ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.0.112:2380"
ETCD_INITIAL_CLUSTER_STATE="existing"

#å°†ä»¥ä¸Šæ•°æ®é…ç½®åˆ°å¼‚å¸¸èŠ‚ç‚¹çš„etcdçš„é…ç½®æ–‡ä»¶ä¸­
vim /etc/etcd/etcd.d/etcd.env

#åœ¨å¼‚å¸¸èŠ‚ç‚¹æ‰§è¡Œï¼Œå¯åŠ¨æœåŠ¡
systemctl start etcd
```

### 2.4ï¼Œå®‰è£…æ§åˆ¶é¢ç»„ä»¶
è¯´æ˜ï¼šæ§åˆ¶é¢ç»„ä»¶é™¤kubeletï¼Œå…¶ä½™ä½¿ç”¨é™æ€podè¿è¡Œ
- é™æ€podï¼šæ˜¯ kubelet æœ¬åœ°ç®¡ç†çš„ Podï¼Œä¸ç»è¿‡ kube-apiserver è°ƒåº¦ï¼Œç”Ÿå‘½å‘¨æœŸç”±æœ¬åœ°yamlæ–‡ä»¶æ§åˆ¶ï¼Œå…¶é»˜è®¤è·¯å¾„æ˜¯ï¼š/etc/kubernetes/manifestsï¼Œé€šå¸¸åœ¨éƒ¨ç½²æ ¸å¿ƒç»„ä»¶ï¼ˆå¦‚ `kube-apiserver`ã€`etcd` ç­‰ï¼‰æ—¶ä½¿ç”¨ã€‚é™æ€podä¸èƒ½é€šè¿‡Kubectl deleteåˆ é™¤ï¼Œåªèƒ½åˆ é™¤æœ¬åœ°yamlæ–‡ä»¶å®ç°ã€‚
#### 2.4.1ï¼Œå®‰è£…kubelet
==æ‰€æœ‰èŠ‚ç‚¹==
è§£ækubeletï¼š
kubelet æ˜¯ Kubernetes æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£æ ¹æ® apiserver çš„æŒ‡ä»¤åˆ›å»ºã€ç®¡ç†å’Œç›‘æ§æœ¬èŠ‚ç‚¹ä¸Šçš„ Pod å®¹å™¨ã€‚å®ƒé€šè¿‡å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ containerdï¼‰å®é™…è¿è¡Œå®¹å™¨ï¼Œå¹¶æŒç»­ä¸ŠæŠ¥èŠ‚ç‚¹ä¸ Pod çš„çŠ¶æ€ã€‚å›¾è§£å¦‚ä¸‹ï¼š
```diff
+-------------------------+
|     kube-apiserver      |
+-------------------------+
           |
   è·å– Pod å¯¹è±¡ (watch)
           â†“
+-------------------------+
|        kubelet          |
+-------------------------+
| Watch è‡ªèº«èŠ‚ç‚¹çš„ Pod    |
| åˆ›å»º Podï¼ˆæŒ‰ CRI è°ƒç”¨ï¼‰ |
| æŒ‚è½½ Volume             |
| é…ç½®ç½‘ç»œï¼ˆCNIï¼‰         |
| å®¹å™¨å¥åº·æ£€æŸ¥           |
| å‘ apiserver ä¸ŠæŠ¥çŠ¶æ€   |
+-------------------------+
           â†“
   è°ƒç”¨ containerd/socket
           â†“
+-------------------------+
|      containerd         |
+-------------------------+
| æ‹‰å–é•œåƒã€è¿è¡Œå®¹å™¨ç­‰    |
+-------------------------+

```

å¤„ç†å®‰è£…æ–‡ä»¶ï¼š
```shell
#ä¸‹è½½
wget https://dl.k8s.io/v1.31.0/kubernetes-server-linux-amd64.tar.gz
#è§£å‹
tar -zxvf kubernetes-server-linux-amd64.tar.gz
#éƒ¨ç½²
cp kubernetes/server/bin/kubelet /usr/local/bin/
cp kubernetes/server/bin/kubectl /usr/local/bin/
#æˆæƒ
chmod +x /usr/local/bin/kubelet
chmod +x /usr/local/bin/kubectl
```
è¿™é‡Œæ‹·è´äº†kubectlï¼Œå› ä¸ºä»è¿™é‡Œå¼€å§‹éœ€è¦ä½¿ç”¨åˆ°kubectlã€‚

```shell
#åˆ›å»ºkebeleté…ç½®ç›®å½•
mkdir -p /var/lib/kubelet
#åˆ›å»ºé™æ€podé…ç½®æ–‡ä»¶ç›®å½•
mkdir -p /etc/kubernetes/manifests
```

kubeletçš„é…ç½®æ–‡ä»¶
```shell
cat > /var/lib/kubelet/config.yaml <<EOF
apiVersion: kubelet.config.k8s.io/v1beta1
kind: KubeletConfiguration

authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/kubernetes/ca.pem

authorization:
  mode: Webhook

cgroupDriver: systemd

clusterDNS:
  - 169.254.25.10
clusterDomain: cluster.local

staticPodPath: /etc/kubernetes/manifests

kubeReserved:
  cpu: 200m
  memory: 250Mi
systemReserved:
  cpu: 200m
  memory: 250Mi

evictionHard:
  memory.available: 5%
  pid.available: 10%
evictionSoft:
  memory.available: 10%
evictionSoftGracePeriod:
  memory.available: 2m
evictionMaxPodGracePeriod: 120
evictionPressureTransitionPeriod: 30s

featureGates:
  RotateKubeletServerCertificate: true
rotateCertificates: true
EOF

#æˆæƒ
chmod 600 /var/lib/kubelet/config.yaml
```
å‚æ•°è§£æï¼š
- clusterDomainï¼šæŒ‡å®šé›†ç¾¤å†…éƒ¨DNSåç¼€ï¼Œé»˜è®¤å€¼ä¸ºcluster.local


==ç”Ÿæˆkubelet.kubeconfigï¼š==
æ–¹æ³•ä¸€ï¼šæ–¹æ³•å·²éªŒè¯
bootstrap.kubeconfig
ä½œç”¨ï¼šåœ¨é¦–æ¬¡éƒ¨ç½²é›†ç¾¤çš„æ—¶å€™ï¼Œä»¥åŠåæœŸè‡ªåŠ¨ç”³è¯·å’Œè½®è½¬è¯ä¹¦

åˆ›å»º kubelet çš„ bootstrap é…ç½®æ–‡ä»¶ï¼š
```bash
cat > kubelet-kubeconfig.sh << EOF
# ç”Ÿæˆtoken
TOKEN_ID=$(head -c 6 /dev/urandom | od -An -t x | tr -d ' ')
TOKEN_SECRET=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')
BOOTSTRAP_TOKEN="${TOKEN_ID}.${TOKEN_SECRET}"

# ç”Ÿæˆbootstrap.kubeconfig
kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=/var/lib/kubelet/bootstrap.kubeconfig

kubectl config set-credentials kubelet-bootstrap \
  --token=$BOOTSTRAP_TOKEN \
  --kubeconfig=/var/lib/kubelet/bootstrap.kubeconfig

kubectl config set-context default \
  --cluster=kubernetes \
  --user=kubelet-bootstrap \
  --kubeconfig=/var/lib/kubelet/bootstrap.kubeconfig

kubectl config use-context default --kubeconfig=/etc/kubernetes/bootstrap.kubeconfig
EOF

# æ‰§è¡Œç”Ÿæˆ
sh kubelet-kubeconfig.sh
# è®¾ç½®æƒé™
chmod 600 var/lib/kubelet/bootstrap.kubeconfig

#ä¼šç”Ÿæˆç±»ä¼¼äºkubeconfigçš„æ–‡ä»¶
```

æ–¹æ³•äºŒï¼šå·²éªŒè¯
å¦‚æœä¸ä½¿ç”¨bootstrap.kubeconfigï¼Œåˆ™éœ€è¦æ‰‹åŠ¨ä¸ºæ¯ä¸ªèŠ‚ç‚¹ç­¾å‘kubeletçš„clientè¯ä¹¦ï¼ˆæ­¤è¯ä¹¦åœ¨ä¸Šé¢ç­¾å‘è¯ä¹¦æ­¥éª¤å·²ç»å®Œæˆï¼‰å’Œæ„å»ºkubelet.kubeconfig

```bash
cat > kubelet-kubeconfig.sh << EOF
kubectl config set-cluster cluster.local \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=/var/lib/kubelet/kubeconfig

kubectl config set-credentials system:node:test-master-01 \
  --client-certificate=/etc/kubernetes/pki/kubernetes/kubelet-client-master1.pem \
  --client-key=/etc/kubernetes/pki/kubernetes/kubelet-client-master1-key.pem \
  --embed-certs=true \
  --kubeconfig=/var/lib/kubelet/kubeconfig

kubectl config set-context system:node:test-master-01@cluster.local \
  --cluster=cluster.local \
  --user=system:node:test-master-01 \
  --kubeconfig=/var/lib/kubelet/kubeconfig

kubectl config use-context system:node:test-master-01@cluster.local --kubeconfig=/var/lib/kubelet/kubeconfig
EOF

#å…¶ä»–èŠ‚ç‚¹ä¿®æ”¹å¯¹åº”å€¼
sed -i s/master-01/node-01/g kubelet-kubeconfig.sh && \
sed -i s/master1/node1/g kubelet-kubeconfig.sh

#æ‰§è¡Œç”Ÿæˆ
sh kubelet-kubeconfig.sh

#ä¼šç”Ÿæˆç±»ä¼¼äºkubeconfigçš„æ–‡ä»¶

#è®¾ç½®æƒé™
chmod 600 /var/lib/kubelet/kubeconfig
```
æ³¨æ„ç‚¹è¯´æ˜ï¼š
æ–¹æ³•äºŒçš„æ­¥éª¤ä¸­ï¼Œâ€œsystem:node:test-master-01â€ä¸¤ä¸ªå€¼ï¼Œä»£è¡¨åœ¨kubeletå‘apiserverå‘é€è¯·æ±‚æ—¶æ ¡éªŒçš„ç”¨æˆ·åã€‚è¿™ä¸ªå€¼æœ€å¥½å’Œä¸Šé¢ç­¾å‘è¯ä¹¦æ—¶æŒ‡å®šçš„â€œCNâ€ä¿æŒä¸€è‡´ï¼ˆè™½ç„¶å®˜æ–¹æœªå¼ºåˆ¶ï¼‰ã€‚å…¶è¡¨ç¤ºæ˜¯systemçš„ç³»ç»Ÿç”¨æˆ·ï¼Œæ¥è‡ªnodeèŠ‚ç‚¹çš„å…·ä½“æŸä¸ªèŠ‚ç‚¹ã€‚

systemdé…ç½®ï¼š
```shell
cat > /etc/systemd/system/kubelet.service << EOF
[Unit]
Description=kubelet: The Kubernetes Node Agent
Documentation=https://kubernetes.io/docs/
After=containerd.service
Requires=containerd.service

[Service]
CPUAccounting=true
MemoryAccounting=true
ExecStart=/usr/local/bin/kubelet \
  --container-runtime-endpoint=unix:///run/containerd/containerd.sock \
  --config=/var/lib/kubelet/config.yaml \
  --kubeconfig=/var/lib/kubelet/kubeconfig \
  --client-ca-file=/etc/kubernetes/pki/kubernetes/ca.pem \
  --tls-cert-file=/etc/kubernetes/pki/kubernetes/kubelet-server-master1.pem \
  --tls-private-key-file=/etc/kubernetes/pki/kubernetes/kubelet-server-master1-key.pem \
  --bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig

Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

```bash
sed -i s/master1/master2/g /etc/systemd/system/kubelet.service
```
å‚æ•°è§£æï¼š
container-runtime-endpointï¼šæŒ‡å®š kubelet ä½¿ç”¨å“ªä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œå³ä½¿èŠ‚ç‚¹åªå®‰è£…äº†ä¸€ç§è¿è¡Œæ—¶
configï¼šæŒ‡å®š kubelet çš„ä¸»é…ç½®æ–‡ä»¶è·¯å¾„
kubeconfigï¼šæŒ‡å®š kubelet ä¸ kube-apiserver é€šä¿¡æ‰€ç”¨çš„è®¤è¯å‡­æ®æ–‡ä»¶
bootstrap-kubeconfigï¼šä»…å½“ä½¿ç”¨bootstrap.kubeconfigè‡ªåŠ¨ç”Ÿæˆkubecongfigæ—¶æ‰éœ€è¦ä½¿ç”¨æ­¤é…ç½®é¡¹

```bash
#é‡æ–°åŠ è½½é…ç½®
systemctl daemon-reload
#å¯åŠ¨
systemctl restart kubelet
```

æ³¨æ„ï¼šæ­¤æ—¶ kubelet å¯èƒ½å›  API Server æœªè¿è¡Œè€ŒæŠ¥é”™ï¼Œä½†ä¼šæŒç»­å°è¯•è¿æ¥ï¼Œè¿™æ˜¯æ­£å¸¸è¡Œä¸ºã€‚
å¯åŠ¨åå¦‚ä¸‹å›¾ï¼Œæ˜¾ç¤ºapiserverè¿æ¥å¤±è´¥ï¼š
![[Pasted image 20250519133808.png]]

#### 2.4.2ï¼Œå®‰è£…kube-apiserver
==masterèŠ‚ç‚¹==
åˆ›å»ºkube-apiserveré…ç½®æ–‡ä»¶
```bash
cat > /etc/kubernetes/manifests/kube-apiserver.yaml << EOF
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - name: kube-apiserver
    image: registry.cn-beijing.aliyuncs.com/alphesh-soft/kube-apiserver:v1.31.0
    command:
    - kube-apiserver
    - --advertise-address=192.168.0.111
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --bind-address=0.0.0.0
    - --client-ca-file=/etc/kubernetes/pki/kubernetes/ca.pem
    - --enable-admission-plugins=NodeRestriction
    - --enable-bootstrap-token-auth=true
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.pem
    - --etcd-certfile=/etc/kubernetes/pki/etcd/apiserver-etcd.pem
    - --etcd-keyfile=/etc/kubernetes/pki/etcd/apiserver-etcd-key.pem
    - --etcd-servers=https://192.168.0.111:2379,https://192.168.0.112:2379,https://192.168.0.113:2379
    - --feature-gates=RotateKubeletServerCertificate=true
    - --kubelet-client-certificate=/etc/kubernetes/pki/kubernetes/apiserver-kubelet-client.pem
    - --kubelet-client-key=/etc/kubernetes/pki/kubernetes/apiserver-kubelet-client-key.pem
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy/front-proxy-client.pem
    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy/front-proxy-client-key.pem
    - --requestheader-allowed-names=front-proxy-client
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy/front-proxy-ca.pem
    - --requestheader-extra-headers-prefix=X-Remote-Extra-
    - --requestheader-group-headers=X-Remote-Group
    - --requestheader-username-headers=X-Remote-User
    - --secure-port=6443
    - --service-account-issuer=https://kubernetes.default.svc.cluster.local
    - --service-account-key-file=/etc/kubernetes/pki/sa/sa.pub
    - --service-account-signing-key-file=/etc/kubernetes/pki/sa/sa.key
    - --service-cluster-ip-range=10.233.0.0/18
    - --tls-cert-file=/etc/kubernetes/pki/kubernetes/apiserver.pem
    - --tls-private-key-file=/etc/kubernetes/pki/kubernetes/apiserver-key.pem
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 192.168.0.111
        path: /livez
        port: 6443
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    readinessProbe:
      failureThreshold: 3
      httpGet:
        host: 192.168.0.111
        path: /readyz
        port: 6443
        scheme: HTTPS
      periodSeconds: 1
      timeoutSeconds: 15
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 192.168.0.111
        path: /livez
        port: 6443
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    resources:
      requests:
        cpu: 250m
    volumeMounts:
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    securityContext:
      seccompProfile:
        type: RuntimeDefault
  hostNetwork: true
  priorityClassName: system-node-critical
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
EOF
```
éƒ¨åˆ†å‚æ•°è§£æï¼š
--allow-privileged=trueï¼šä½¿ç”¨ç‰¹æƒæ¨¡å¼
--authorization-mode=Node,RBACï¼š
- Nodeï¼šå…è®¸èŠ‚ç‚¹ï¼ˆkubeletï¼‰é€šè¿‡ç‰¹å®šçš„æƒé™è®¿é—® APIï¼Œç”¨äºè·å– Pod ä¿¡æ¯ã€æŠ¥å‘ŠèŠ‚ç‚¹çŠ¶æ€ç­‰ã€‚
- RBACï¼ˆRole-Based Access Controlï¼‰ï¼šåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼Œé€šè¿‡å®šä¹‰è§’è‰²å’Œç»‘å®šæ¥ç®¡ç†ç”¨æˆ·å’Œç»„ä»¶çš„æƒé™ã€‚
--enable-admission-plugins=NodeRestrictionï¼šå¯ç”¨ç‰¹å®šçš„å‡†å…¥æ§åˆ¶æ’ä»¶ï¼ŒNodeRestrictionæ˜¯å…¶ä¸­æ¨èçš„ä¸€ç§æ’ä»¶ã€‚NodeRestrictionæ’ä»¶é™åˆ¶ kubelet çš„æƒé™ï¼Œä»…å…è®¸å…¶ç®¡ç†è‡ªèº«èŠ‚ç‚¹ç›¸å…³çš„èµ„æºï¼ˆå¦‚è‡ªå·±çš„ Podã€Node å¯¹è±¡ï¼‰ã€‚è¿™å¢å¼ºäº†é›†ç¾¤å®‰å…¨æ€§ï¼Œé˜²æ­¢ kubelet è®¿é—®å…¶ä»–èŠ‚ç‚¹çš„èµ„æº
--service-cluster-ip-rangeï¼šæŒ‡å®š Kubernetes Service çš„ ClusterIP åœ°å€èŒƒå›´ï¼Œå³service CIDRï¼Œé»˜è®¤å€¼ 10.96.0.0/12ï¼ˆçº¦ 100 ä¸‡ä¸ª IPï¼‰é€‚åˆå¤§å¤šæ•°é›†ç¾¤ã€‚

ï¼ï¼ï¼
è¿™é‡Œæ³¨æ„ä¸€ä¸ªé—®é¢˜
--service-cluster-ip-rangeå‚æ•°çš„å€¼ï¼Œå†³å®šäº†svcçš„ClusterIPï¼ŒåŒæ ·ä¼šå†³å®šapiserverçš„ClusterIPã€‚æ¯”å¦‚å‚æ•°å€¼æ˜¯ï¼š10.96.0.0/12ï¼Œapiserveråœ¨åˆå§‹åŒ–åï¼Œç”Ÿæˆçš„apiserverçš„ClusterIPå¯èƒ½å°±æ˜¯10.96.0.1ï¼Œè¿™ä¸ªipä¹Ÿæ˜¯å…¶ä»–ç»„ä»¶ï¼ˆæ¯”å¦‚cniç½‘ç»œæ’ä»¶ï¼‰è¿æ¥apiserverçš„é»˜è®¤åœ°å€ã€‚æ­¤åœ°å€å¦‚æœä¸ä½¿ç”¨é»˜è®¤çš„ï¼Œéœ€è¦ç›¸åº”çš„ä¿®æ”¹å…¶ä»–ç»„ä»¶è¿æ¥apiserverçš„åœ°å€ã€‚å¦åˆ™ä¼šå¯¼è‡´å…¶ä»–ç»„ä»¶è¿æ¥ä¸åˆ°é›†ç¾¤ã€‚


å¤åˆ¶æ–‡ä»¶åˆ°æ‰€æœ‰masterèŠ‚ç‚¹
```bash
scp kube-apiserver.yaml 192.168.0.112:/etc/kubernetes/manifests
```

å½“yamlæ–‡ä»¶æ”¾åˆ°/etc/kubernetes/manifestsç›®å½•åï¼Œkubeletä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”é™æ€pod
```bash
# æŸ¥è¯¢pod
crictl ps -a
```

#### 2.4.3ï¼Œkube-controller-manager

ç”Ÿæˆcontroller-manager.kubeconfig
```bash
cat > controller-manager-kubeconfig.sh << EOF
kubectl config set-cluster cluster.local \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

kubectl config set-credentials system:kube-controller-manager \
  --client-certificate=/etc/kubernetes/pki/kubernetes/controller-manager.pem \
  --client-key=/etc/kubernetes/pki/kubernetes/controller-manager-key.pem \
  --embed-certs=true \
  --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

kubectl config set-context system:kube-controller-manager@cluster.local \
  --cluster=cluster.local \
  --user=system:kube-controller-manager \
  --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig

kubectl config use-context system:kube-controller-manager@cluster.local --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
EOF

# æ‰§è¡Œç”Ÿæˆ
sh controller-manager-kubeconfig.sh
# è®¾ç½®æƒé™
chmod 600 /etc/kubernetes/controller-manager.kubeconfig

#ä¼šç”Ÿæˆç±»ä¼¼äºkubeconfigçš„æ–‡ä»¶
```

åˆ›å»ºkube-controller-manageré…ç½®æ–‡ä»¶
```bash
cat > /etc/kubernetes/manifests/kube-controller-manager.yaml << EOF
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kube-controller-manager
    tier: control-plane
  name: kube-controller-manager
  namespace: kube-system
spec:
  containers:
  - name: kube-controller-manager
    image: registry.cn-beijing.aliyuncs.com/alphesh-soft/kube-controller-manager:v1.31.0
    command:
    - kube-controller-manager
    args:
    - --allocate-node-cidrs=true
    - --authentication-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
    - --authorization-kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
    - --bind-address=0.0.0.0
    - --client-ca-file=/etc/kubernetes/pki/kubernetes/ca.pem
    - --cluster-cidr=10.233.64.0/18
    - --cluster-name=cluster.local
    - --cluster-signing-cert-file=/etc/kubernetes/pki/kubernetes/ca.pem
    - --cluster-signing-duration=87600h
    - --cluster-signing-key-file=/etc/kubernetes/pki/kubernetes/ca-key.pem
    - --controllers=*
    - --feature-gates=RotateKubeletServerCertificate=true
    - --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig
    - --leader-elect=true
    - --node-cidr-mask-size=24
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy/front-proxy-ca.pem
    - --root-ca-file=/etc/kubernetes/pki/kubernetes/ca.pem
    - --service-account-private-key-file=/etc/kubernetes/pki/sa/sa.key
    - --service-cluster-ip-range=10.233.0.0/18
    - --use-service-account-credentials=true
    livenessProbe:
      failureThreshold: 8
      httpGet:
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    startupProbe:
      failureThreshold: 24
      httpGet:
        path: /healthz
        port: 10257
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    resources:
      requests:
        cpu: 200m
    volumeMounts:
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /etc/kubernetes/controller-manager.kubeconfig
      name: kubeconfig
      readOnly: true
    securityContext:
      seccompProfile:
        type: RuntimeDefault
  hostNetwork: true
  priorityClassName: system-node-critical
  volumes:
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /etc/kubernetes/controller-manager.kubeconfig
      type: FileOrCreate
    name: kubeconfig
EOF

# 3ä¸ªmasterèŠ‚ç‚¹å‡éœ€è¦æ­¤æ–‡ä»¶
```
å‚æ•°è§£æï¼š
--allocate-node-cidrsï¼šå¯ç”¨ä¸ºæ¯ä¸ªnodeåˆ†é…pod CIDRï¼›
--cluster-cidrï¼šä¸ºæ¯ä¸ª Node åˆ†é…ä¸€ä¸ª `spec.podCIDR`ï¼ˆæ¯”å¦‚ `10.244.0.0/24`ï¼‰ï¼Œè¿™ä¸ªå­—æ®µ`ç†è®ºä¸Š`åº”è¯¥è¢« CNI æ’ä»¶ç”¨äºåœ¨è¯¥ Node ä¸Šåˆ†é… Pod IPï¼›
#### 2.4.4ï¼Œkube-scheduler

ç”Ÿæˆkube-scheduler.kubeconfig
```bash
cat > scheduler-kubeconfig.sh << EOF
kubectl config set-cluster cluster.local \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config set-credentials system:kube-scheduler \
  --client-certificate=/etc/kubernetes/pki/kubernetes/scheduler.pem \
  --client-key=/etc/kubernetes/pki/kubernetes/scheduler-key.pem \
  --embed-certs=true \
  --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config set-context system:kube-scheduler@cluster.local \
  --cluster=cluster.local \
  --user=system:kube-scheduler \
  --kubeconfig=/etc/kubernetes/scheduler.kubeconfig

kubectl config use-context system:kube-scheduler@cluster.local --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
EOF

# æ‰§è¡Œç”Ÿæˆ
sh scheduler-kubeconfig.sh
# è®¾ç½®æƒé™
chmod 600 /etc/kubernetes/scheduler.kubeconfig

#ä¼šç”Ÿæˆç±»ä¼¼äºkubeconfigçš„æ–‡ä»¶
```

åˆ›å»ºkube-scheduleré…ç½®æ–‡ä»¶
```bash
cat > /etc/kubernetes/manifests/kube-scheduler.yaml << EOF
apiVersion: v1
kind: Pod
metadata:
  labels:
    component: kube-scheduler
    tier: control-plane
  name: kube-scheduler
  namespace: kube-system
spec:
  containers:
  - name: kube-scheduler
    image: registry.cn-beijing.aliyuncs.com/alphesh-soft/kube-scheduler:v1.31.0
    command:
    - kube-scheduler
    - --authentication-kubeconfig=/etc/kubernetes/scheduler.kubeconfig
    - --authorization-kubeconfig=/etc/kubernetes/scheduler.kubeconfig
    - --bind-address=0.0.0.0
    - --feature-gates=RotateKubeletServerCertificate=true
    - --kubeconfig=/etc/kubernetes/scheduler.kubeconfig
    - --leader-elect=true
    livenessProbe:
      failureThreshold: 8
      httpGet:
        path: /healthz
        port: 10259
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    startupProbe:
      failureThreshold: 24
      httpGet:
        path: /healthz
        port: 10259
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    resources:
      requests:
        cpu: 100m
    volumeMounts:
    - mountPath: /etc/kubernetes/scheduler.kubeconfig
      name: kubeconfig
      readOnly: true
    securityContext:
      seccompProfile:
        type: RuntimeDefault
  hostNetwork: true
  priorityClassName: system-node-critical
  volumes:
  - hostPath:
      path: /etc/kubernetes/scheduler.kubeconfig
      type: FileOrCreate
    name: kubeconfig
EOF

# 3ä¸ªmasterèŠ‚ç‚¹å‡éœ€è¦æ­¤æ–‡ä»¶
```


#### 2.4.5ï¼Œkubectlè¿æ¥é›†ç¾¤
```bash
mkdir ~/.kube
```

ç”Ÿæˆadminçš„kubeconfig
```bash
cat > admin-kubeconfig.sh << EOF
kubectl config set-cluster cluster.local \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=/root/.kube/config

kubectl config set-credentials kubernetes-admin \
  --client-certificate=/etc/kubernetes/pki/kubernetes/admin.pem \
  --client-key=/etc/kubernetes/pki/kubernetes/admin-key.pem \
  --embed-certs=true \
  --kubeconfig=/root/.kube/config

kubectl config set-context kubernetes-admin@cluster.local \
  --cluster=cluster.local \
  --user=kubernetes-admin \
  --kubeconfig=/root/.kube/config

kubectl config use-context kubernetes-admin@cluster.local --kubeconfig=/root/.kube/config
EOF

# æ‰§è¡Œç”Ÿæˆ
sh scheduler-kubeconfig.sh
# è®¾ç½®æƒé™
chmod 600 /root/.kube/config

#ä¼šç”Ÿæˆç±»ä¼¼äºkubeconfigçš„æ–‡ä»¶

# æ­¤æ—¶å³å¯ä½¿ç”¨kubectlæŸ¥è¯¢é›†ç¾¤èµ„æº
```

---
æ­¤æ—¶k8sçš„æ§åˆ¶é¢ç»„ä»¶å®‰è£…å®Œæˆï¼Œå¯ä»¥ä½¿ç”¨kubectl get pod -AæŸ¥è¯¢åˆ°é™æ€pod
![[Pasted image 20250523165702.png]]

ä½†æ˜¯èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯NotReadyï¼Œä¸”nodeèŠ‚ç‚¹æœªåŠ å…¥
![[Pasted image 20250523165743.png]]

é€šè¿‡æŸ¥è¯¢èŠ‚ç‚¹è¯¦æƒ…
kubectl describe node test-master-01

èƒ½çœ‹åˆ°æ—¥å¿—ï¼Œæ˜¾ç¤ºcniæ’ä»¶æœªå®‰è£…ï¼Œä½†æ˜¯ä¸Šé¢çš„æ­¥éª¤ä¸­å·²ç»å®‰è£…cniäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯æœªå®‰è£…æ’ä»¶
![[Pasted image 20250523165923.png]]

### 2.4.6ï¼Œå®‰è£…kube-proxy
kube-proxyæ˜¯k8sä¸­å¯¹serviceèµ„æºçš„ä»£ç†ï¼Œå½“è®¿é—®serviceæ—¶ï¼Œkube-proxyä¼šå°†è¯·æ±‚è½¬å‘è‡³serviceåç«¯çš„ä»»æ„ä¸€ä¸ªpodã€‚æœ‰ä»£ç†å’Œè´Ÿè½½å‡è¡¡çš„ä½œç”¨ã€‚proxyæœ¬èº«ä¸å¤„ç†æµé‡ï¼Œè€Œæ˜¯è½¬å‘ç»™ipvsæˆ–iptablesè§„åˆ™ç”±å…¶å¤„ç†ã€‚å…¶æ ¸å¿ƒæ˜¯ipvsæˆ–iptablesã€‚ä¸»è¦ä»»åŠ¡ï¼š
- **ç›‘å¬ Kubernetes çš„ Service/Endpoints å˜åŒ–**
- **æ„å»ºæœ¬åœ° Node çš„è½¬å‘è§„åˆ™**
- **ä½¿ç”¨æŸç§æ–¹å¼å®ç°æµé‡è½¬å‘ï¼šiptablesã€ipvs æˆ– userspace**

ä¸€èˆ¬ä½¿ç”¨daemonsetæ¥éƒ¨ç½²kube-proxy
ç”Ÿæˆkubeconfig
```bash
cat > proxy-kubeconfig.sh << EOF
kubectl config set-cluster cluster.local \
  --server=https://127.0.0.1:6443 \
  --certificate-authority=/etc/kubernetes/pki/kubernetes/ca.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-credentials system:kube-proxy \
  --client-certificate=/etc/kubernetes/pki/kubernetes/kube-proxy.pem \
  --client-key=/etc/kubernetes/pki/kubernetes/kube-proxy-key.pem \
  --embed-certs=true \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config set-context system:kube-proxy:cluster.local \
  --cluster=cluster.local \
  --user=system:kube-proxy \
  --kubeconfig=kube-proxy.kubeconfig

kubectl config use-context system:kube-proxy:cluster.local --kubeconfig=kube-proxy.kubeconfig
EOF
```


åˆ›å»ºkube-proxy-configmap.yaml
```bash
vim kube-proxy-configmap.yaml
```

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: kube-proxy
  namespace: kube-system
  labels:
    app: kube-proxy
data:
  config.conf: |-
    apiVersion: kubeproxy.config.k8s.io/v1alpha1
    kind: KubeProxyConfiguration
    bindAddress: 0.0.0.0
    clientConnection:
      kubeconfig: /var/lib/kube-proxy/kubeconfig.conf
    clusterCIDR: 10.233.64.0/18
    mode: ipvs
    hostnameOverride: ""
    iptables:
      masqueradeAll: false
      masqueradeBit: 14
      syncPeriod: 30s
    ipvs:
      strictARP: false
  kubeconfig.conf: |-
    apiVersion: v1
    kind: Config
    clusters:
    - cluster:
        certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURwakNDQW82Z0F3SUJBZ0lVVTVTMGp3MnlqNmlJc0hPYkFYaXFPYnlBMDBrd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2F6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEV6QVJCZ05WQkFvVENrdDFZbVZ5Ym1WMFpYTXhDekFKQmdOVkJBc1RBa05CTVJZd0ZBWURWUVFECkV3MXJkV0psY201bGRHVnpMV05oTUI0WERUSTFNRFV5TURBMU1EUXdNRm9YRFRNd01EVXhPVEExTURRd01Gb3cKYXpFTE1Ba0dBMVVFQmhNQ1EwNHhFREFPQmdOVkJBZ1RCMEpsYVdwcGJtY3hFREFPQmdOVkJBY1RCMEpsYVdwcApibWN4RXpBUkJnTlZCQW9UQ2t0MVltVnlibVYwWlhNeEN6QUpCZ05WQkFzVEFrTkJNUll3RkFZRFZRUURFdzFyCmRXSmxjbTVsZEdWekxXTmhNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXFwajQKUVFMU1BOb1VreFB4SjFMa3M1ZnRUR3FBNTAvSmlTUCtkenNIOWVKR3QybUdvUFpjeThObzlZOFpHd3d1ZXUxYgo3OEwrUnVJQlh3NTVwYzZwYmtpa2ltZUgxNE1HTlNrWmRUTytSN1F0bVhmRWsveUpYU2VtVlJxc3B0QTZDUHcvClBLcXI3MStoOWd5YmxzQityd0J1SWlLZTl6bmc0WDJnemhKck9RbzBjOEpOamUzS2tSOHVCbnh3WDhyUzh4eGoKdkswYzZMTCtRSWFvUmNCZWVCVDJRM1dOekg2VXdwOVgyQi9YWUVMWDF3ZHR0bmQ2a0Q3ZTcydzVFSThRRWdWWQp1aEhZV3ltOTlHVVZHbElPT1Z6WExhSTI5cWN2NHl6T2RXZWZsaEJyVmM2dEJxNFhDUFg4N1ZhaHMvaGlPdUlGCk9aeWt3YWFlVERQa1dxQ1B3d0lEQVFBQm8wSXdRREFPQmdOVkhROEJBZjhFQkFNQ0FRWXdEd1lEVlIwVEFRSC8KQkFVd0F3RUIvekFkQmdOVkhRNEVGZ1FVWGtlZEJvV2FtOElPVlVPRlNRTUY4RXZ4M3NBd0RRWUpLb1pJaHZjTgpBUUVMQlFBRGdnRUJBQ1BqWnIraGNrZTNzK0ltR0QwQzFURENzcUdxWXdBZWZNMStRblhOOTU2aGtWZ2Q4Y1VnCk8xc2NYc1lpei9sUWtHVnBZZk9jdmduOXUrejhxSVh2TzFBMDNCY1lnc2hpTVJFcGp3L2FXZ2pxbzNNVzUzT28Ka2NKd0NpOXhmcUY1dUo1VzZGY2cvU0FhNXJ6bWtuYlprb0ticWtCaDExYnQ3Um1lajJkOGZFdHhWL2Y0YmtJeQp5Y1FwUDVWeXhFWkdibnBaenFjWWhlVDRTVVhRSmxvTmZQT3NISktmRTA3YXVPU1RvbThwN1UwdFB2ejgzOExaCldBT2pCQlNBN2JWa09tLzI1NTRqM01pM08yM3QvaWNUcmcxeUR4bmdZUnpvYWtBMXExWHIyRGFlODlYbTllZVcKd01XRjFJMHZNT0xkNDhmTFpJb25ET1FCU2dnMTVGUDZKdjQ9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
        server: https://127.0.0.1:6443
      name: cluster.local
    contexts:
    - context:
        cluster: cluster.local
        user: system:kube-proxy
      name: system:kube-proxy:cluster.local
    current-context: system:kube-proxy:cluster.local
    preferences: {}
    users:
    - name: system:kube-proxy
      user:
        client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ5akNDQXQ2Z0F3SUJBZ0lVVTJBazhtdzREZTZvTWkxOWdDampZWVJqcDBjd0RRWUpLb1pJaHZjTkFRRUwKQlFBd2F6RUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdUQjBKbGFXcHBibWN4RURBT0JnTlZCQWNUQjBKbAphV3BwYm1jeEV6QVJCZ05WQkFvVENrdDFZbVZ5Ym1WMFpYTXhDekFKQmdOVkJBc1RBa05CTVJZd0ZBWURWUVFECkV3MXJkV0psY201bGRHVnpMV05oTUI0WERUSTFNRFV5T0RBeU5UY3dNRm9YRFRNMU1EVXlOakF5TlRjd01Gb3cKZmpFTE1Ba0dBMVVFQmhNQ1EwNHhFREFPQmdOVkJBZ1RCMEpsYVdwcGJtY3hFREFPQmdOVkJBY1RCMEpsYVdwcApibWN4R2pBWUJnTlZCQW9URVhONWMzUmxiVHByZFdKbExYQnliM2g1TVJNd0VRWURWUVFMRXdwTGRXSmxjbTVsCmRHVnpNUm93R0FZRFZRUURFeEZ6ZVhOMFpXMDZhM1ZpWlMxd2NtOTRlVENDQVNJd0RRWUpLb1pJaHZjTkFRRUIKQlFBRGdnRVBBRENDQVFvQ2dnRUJBSnpOWVprcGVIbUlSVE8yZUpPOFF2WXN6UnV6eGlvZnVwUDliQlFaQWticwp0RWo0NjVxZ2F2Q2xUMDVUdVNEcEg0Ujh3VDFsbnBoSUU0UDY3bWRKUmk5d0doNEZ5M0ZFaWtyeHJpMDlSSWJBCm05eWtlbFBYNjFSaElpRjloei82OVJ6NU52dlZrQmplbHVuc1VOTVlIZGE2RGhkdWY4NDZGRWd1L0owa3plQWoKUXdBVXNTcmh4VC8yWjdRdTBtZzNPemQ3Mm5nRzlReGRPRGs4VDdLR01ucXZFcFljcTN4OUoyM0N0NlpHRk1BUgo1MWtXc2tGdXBXb3lPS1NibGh0V25aRVJHclpCU1YzT2NUdXIrN1NERnRDTXpSRVAwak9TNWdLV3R4YlpraUpFCnlRWnJ1R2FWYjNsTkF1RTlONndxU0E3ZVdJcGNzV29nQ3dyOFNBWkoxeThDQXdFQUFhTi9NSDB3RGdZRFZSMFAKQVFIL0JBUURBZ1dnTUIwR0ExVWRKUVFXTUJRR0NDc0dBUVVGQndNQkJnZ3JCZ0VGQlFjREFqQU1CZ05WSFJNQgpBZjhFQWpBQU1CMEdBMVVkRGdRV0JCU28zTFRINHVZaG9HOFhsR2ZibDJsd3JTU3lLREFmQmdOVkhTTUVHREFXCmdCUmVSNTBHaFpxYndnNVZRNFZKQXdYd1MvSGV3REFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBWVY2aDdsMlkKMVJDM3dpQzlnV1M4T0pwM2VUU1BGQXFyQk1PWHlnRm1QcFJxYU4yc25xY1pGc2ZLeUVSQWVnQXBMOUZkS25JMwpsU294bHpzTnlneDRhQkR2YTA3bW1HSGw2SVdKNCtsSFVkSkxwYVhyNVFYTHlVY3RXVWxyc1BsMXFuNjV5QzlyCjFRMy9adnBqZWgvLzRsTEt4TzVDMVlBNjBDdmZac3YyRzBVL3hNQlFUalMxanZCYjVYOFNiQjFrZ3FSNEZFaUcKNU4xZkEwN0Y2RXhPY002NmJ1bTAxcHBlSWczdjJaTmQ4YStlbGY3N1FvdytXb1lyL2hoOU4xZzErWVN5cEVodQplS0tEMUQ4R2tvOEw3WHZiVmhJNjFXVEpSL0Jlbm1Wd3Z0bElJY2xEU1pyMk1YOHoxa215V0RXSFkrbWE2TXpxCnk0LzB5bThWcXoyejNRPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
        client-key-data: LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBbk0xaG1TbDRlWWhGTTdaNGs3eEM5aXpORzdQR0toKzZrLzFzRkJrQ1J1eTBTUGpyCm1xQnE4S1ZQVGxPNUlPa2ZoSHpCUFdXZW1FZ1RnL3J1WjBsR0wzQWFIZ1hMY1VTS1N2R3VMVDFFaHNDYjNLUjYKVTlmclZHRWlJWDJIUC9yMUhQazIrOVdRR042VzZleFEweGdkMXJvT0YyNS96am9VU0M3OG5TVE40Q05EQUJTeApLdUhGUC9abnRDN1NhRGM3TjN2YWVBYjFERjA0T1R4UHNvWXllcThTbGh5cmZIMG5iY0szcGtZVXdCSG5XUmF5ClFXNmxhakk0cEp1V0cxYWRrUkVhdGtGSlhjNXhPNnY3dElNVzBJek5FUS9TTTVMbUFwYTNGdG1TSWtUSkJtdTQKWnBWdmVVMEM0VDAzckNwSUR0NVlpbHl4YWlBTEN2eElCa25YTHdJREFRQUJBb0lCQUFKYXN4UnhvdlZ3TGxuUQphNDhNVEpVVnB4NjdYRVpWbzUrRk5wSTJyZW9TczhKRXVvVGYwN3M1UUMrVTRqcTBSVnpmNHFiaFY3aEJuTWxtCmd4M1o0OHZpaXdIWVpHMlc4ZHllTkZkSmpEWFp2bjFabXR5WGFWa2kvRGcwZ2t0Ym9VS0dHMlU4bDZWSDhrd2cKMkRYVEx0K0NlNk91YlF6VG9tcFRDa2Z4dllXWCsremxpTFdXV0JhbjZOdnRYcklNYi9kOUUrK09yOUlneTV1dQpHUkJ3THdITDhQYTgvNUlYZm5xUWk5SklTWXRRQ2dPT3N4VHJwcGQvbmRTUnVHbEU3akxaK1B1OWI2NEJmaGIwCjZxcUhvUVJ2RWZoVndKYmpJR0Y1R3lHaUppaUU3bmhqWWJQU3k1WUJFWVZReURJelNPMDM1OWFVWnhKamRaSzUKRm1DRGJVRUNnWUVBelM3VWp2TDI5YzN2K1REMmlnQSs0akZnY3J1cHFwUm9wRVFKU2orSnB5RUlGUlJ0bXgrTApZdkRmT3lHTkUxUEhvOE91eEh4cXdiazFzYzhXVTR6clNHYnhFdVp3bEowM0laejE0T1V5bjFBb29yTUJQVzN3CkVCR3prT0R5WlBjbWNmN21MWkJCd2hrWXVtMTJpSHR5VXl1c2ZlenpCaTVzSGhxclpaVUIxT3NDZ1lFQXc2TVYKREpmblFKMjdvWXdCZkpjR1pIMkNsRkdKS1BTc1VrWHRHcVNjOHVacDZoUG5zdkQxeUIxbkJ6ck81NExGd1p0MgoyaGlZMUUyTTFOV2pMd3Y5S1lPVGxlOXlLR2pmRjA3Vys3djhTcnk1NmdCNGZLdXhtR0w0MkgxZjhqS2p6bHhmCmlQWjFJYmg5UUl3bkVsRWRJSGJBSmUrUHZrZUlPbXQyRDlDTlJjMENnWUFWZXZxYndJbmtMOXdZbld5aUErYVIKYlpQb1R3Y3pLWGhQQWlScTFuNEZ0aXFQY21VTElXRkpTV2hGVzN6V2NpWHJXaGdZeitHcFNFZDd4dTlTYmVWUAozaDhNMkgwZXdkcTh0UjcwbldvUVRhY0RhWFFPeDB5amtnYlhld1ZGVnE1NnJySFFRVkx4REFtUHN0Zis3OVdICktZSlVhSk1FcWFWOS9WTEdQclJEWXdLQmdENHdmRU41a2tCL0k2TVIzM01jaXlLc3B6TEF6SW9oWlJudU1wWVMKbC9XNit4WTI1Nk9CWjVBS2tMTENwZjBBSEI4VWJXNmMvUkFYNnRuSlk4dFQwMUU4QzFGUlFZZkk5b254UFBQZQo2UzlVMlFDaXo2cEo1ZldjR0tDeEVpdnFueG05VVgwM1l6cXA2OTcxN29HckdVZzFsNVUzbHdrVXNpQm9BcXE2ClQvNU5Bb0dCQU1GUjlma0x2Yzg2SFNseWs5RjVodEljV0M2d2gyR05lVC82NWN0TVNTUjV3SkVJbUlXa2p6bksKN3RZQ0RONG56MzllNHVLWmpsVkZ4YlF6b2VKMVZya3RrSi9pYzZRbXJaN1MzOFRQL3F4WVJZUFJNdk5vS2xCMQp4VitJTjk3aEQ4dUhpcHcxaHRhZFFNUlBiSXdoclA1ZlNvS2tyMUd0MEFwQVJkK3U0YzYvCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
```

åˆ›å»ºæƒé™ç»‘å®škube-proxy-rbac.yaml
```bash
vim kube-proxy-rbac.yaml
```

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kube-proxy
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: system:node-proxier
rules:
  - apiGroups: [""]
    resources: ["services", "endpoints", "pods", "nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["discovery.k8s.io"]
    resources: ["endpointslices"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["events.k8s.io"]
    resources: ["events"]
    verbs: ["create", "patch", "update"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kube-proxy
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: system:node-proxier
subjects:
  - kind: ServiceAccount
    name: kube-proxy
    namespace: kube-system
```

åˆ›å»ºæƒé™ç»‘å®škube-proxy-DaemonSet.yaml
```bash
vim kube-proxy-daemonset.yaml
```

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: kube-proxy
  namespace: kube-system
  labels:
    k8s-app: kube-proxy
spec:
  selector:
    matchLabels:
      k8s-app: kube-proxy
  template:
    metadata:
      labels:
        k8s-app: kube-proxy
    spec:
      hostNetwork: true
      serviceAccountName: kube-proxy
      nodeSelector:
        kubernetes.io/os: linux
      tolerations:
        - operator: Exists
      priorityClassName: system-node-critical
      containers:
        - name: kube-proxy
          image: registry.cn-beijing.aliyuncs.com/alphesh-soft/kube-proxy:v1.31.0
          command:
            - /usr/local/bin/kube-proxy
            - --config=/var/lib/kube-proxy/config.conf
            - --hostname-override=$(NODE_NAME)
          env:
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
          securityContext:
            privileged: true
          imagePullPolicy: IfNotPresent
          volumeMounts:
            - name: kube-proxy
              mountPath: /var/lib/kube-proxy
            - name: xtables-lock
              mountPath: /run/xtables.lock
            - name: lib-modules
              mountPath: /lib/modules
              readOnly: true
      volumes:
        - name: kube-proxy
          configMap:
            name: kube-proxy
        - name: xtables-lock
          hostPath:
            path: /run/xtables.lock
            type: FileOrCreate
        - name: lib-modules
          hostPath:
            path: /lib/modules
      restartPolicy: Always
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  revisionHistoryLimit: 10
```

#### æ‹“å±• IPVSå’Œiptables
åŒºåˆ«
![[Pasted image 20250612102310.png]]

**ipvsï¼š**
å½“åˆ›å»ºä¸€ä¸ªserviceæ—¶ï¼Œipvsä¼šåˆ›å»ºå¤šä¸ªè½¬å‘è§„åˆ™ï¼š
1ï¼ŒClusterIp -> pod ipï¼šæ‰€æœ‰ç±»å‹çš„service
2ï¼ŒNode ip -> pod ipï¼šNodePortå’ŒLoadBanlancer
3ï¼Œtunl0 VIP -> pod ipï¼šNodePortå’ŒLoadBanlancer

æŸ¥è¯¢è§„åˆ™ï¼š
`ipvsadmin -Ln`
![[Pasted image 20250612132614.png]]
è§£æï¼š
- 10.233.0.1:443ï¼Œè¿™ä¸ªæ˜¯apiserverçš„ClusterIPè½¬å‘ï¼Œå±äºk8sç³»ç»Ÿçº§è§„åˆ™ï¼›
- 192.168.0.111:30080ï¼Œæ˜¯NodePortçš„è½¬å‘ï¼Œåˆ°ä¸¤ä¸ªpodï¼š10.233.120.202/203:80
- 10.233.2.192:80ï¼Œæ˜¯ClusterIPçš„è½¬å‘ï¼Œ
- 10.233.82.2:30080ï¼Œæ˜¯tunl0 VIPï¼Œ

1ï¼Œå¤–éƒ¨è¯·æ±‚åˆ°è¾¾nodeip:port
2ï¼Œkube-proxyç›‘å¬apiserver,è·å–serviceå’Œendpointèµ„æºå˜åŒ–
3ï¼Œipvsæ ¹æ®endpointåˆ¤æ–­pod ipå±äºå“ªä¸ªèŠ‚ç‚¹(endpointåŒ…å«podæ‰€å±çš„èŠ‚ç‚¹è¯¦æƒ…)ï¼Œæ­¤å¤„åˆ¤æ–­æ˜¯å¦ä¼šè·¨èŠ‚ç‚¹
4ï¼Œipvsæ£€æŸ¥ipvsè½¬å‘è§„åˆ™ï¼Œæ ¹æ®ä¸Šä¸€æ­¥çš„ç»“æœåˆ¤æ–­ä½¿ç”¨ä»€ä¹ˆè§„åˆ™æ¥è½¬å‘ï¼ˆè§„åˆ™ä¸­åŒ…å«äº†åç«¯podçš„ipå’Œç«¯å£ï¼‰
5ï¼Œå¦‚æœæ˜¯æœ¬èŠ‚ç‚¹ï¼Œä½¿ç”¨nodeip:portè½¬å‘åˆ°podå³å¯
6ï¼Œå¦‚æœæ˜¯è·¨èŠ‚ç‚¹ï¼Œé€šè¿‡æºèŠ‚ç‚¹è·¯ç”±è¡¨è·å–è¿™ä¸ªpod ipçš„è¯·æ±‚åº”è¯¥è½¬å‘çš„ç›®çš„èŠ‚ç‚¹è¯¦æƒ…ï¼ŒåŒ…æ‹¬ç›®çš„èŠ‚ç‚¹ipå’Œtunl0è®¾å¤‡
7ï¼Œé€šè¿‡æºèŠ‚ç‚¹çš„tunl0è®¾å¤‡å°è£…è¯·æ±‚ipåŒ…çš„å¤–å±‚ipä¸ºç›®çš„èŠ‚ç‚¹ipï¼Œå¹¶è½¬å‘å‡ºå»
8ï¼Œåˆ°è¾¾ç›®çš„èŠ‚ç‚¹åï¼Œç”±ç›®æ ‡èŠ‚ç‚¹çš„tunl0è§£å°è£…ï¼Œæå–å†…å±‚ipåŒ…ï¼Œè·å–ç›®çš„pod ipï¼Œé€šè¿‡æ­¤èŠ‚ç‚¹çš„ipvsè·¯ç”±è§„åˆ™(tun0)è½¬å‘åˆ°å®é™…pod





pod ipåˆ†é…è¯¦ç»†æµç¨‹





linux ipè·¯ç”±



**iptablesï¼š**





#### æ‹“å±•ç½‘å¡ (kube-proxy)
kube-proxyç»„ä»¶å®‰è£…æ—¶ï¼Œä¼šåˆ›å»ºä¸¤ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œåˆ†åˆ«æ˜¯ï¼škube-ipvs0å’Œtunl0ã€‚
- kube-ipvs0ï¼šæ˜¯é›†ç¾¤ClusterIPä½¿ç”¨ï¼Œå³serviceä½¿ç”¨ï¼Œå½“åˆ›å»ºä¸€ä¸ªserviceæ—¶ï¼Œä¼šåœ¨è¿™ä¸ªç½‘å¡ä¸‹é¢æ–°å¢ä¸€ä¸ªè™šæ‹Ÿipã€‚å…¶ipç”±apiserveråˆ†é…
- tunl0ï¼šæ˜¯ç”¨äºè·¨èŠ‚ç‚¹è®¿é—®ï¼Œip in ipçš„æµé‡å°è£…ï¼Œå…¶ipç”±cniæ’ä»¶åˆ†é…ï¼Œæ¯ä¸ªèŠ‚ç‚¹ä»…æœ‰ä¸€ä¸ªip
tunl0 ipè¯¦è§£ï¼š
ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„è¿™ä¸¤ä¸ªç½‘å¡


---

## 3ï¼Œå®‰è£…æ‰©å±•ç»„ä»¶


### 3.1ï¼Œå®‰è£…cniæ’ä»¶
==**è§£é‡ŠCNIï¼š**==
CNIï¼ˆContainer Network Interfaceï¼‰æ˜¯ä¸€ç§ç”¨äºé…ç½®å®¹å™¨ç½‘ç»œçš„æ’ä»¶è§„èŒƒã€‚å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªæ’ä»¶æœ¬èº«ï¼Œè€Œæ˜¯ä¸€ç»„**è§„èŒƒ + æ’ä»¶æ‰§è¡Œæ¥å£**ï¼Œç”¨äºå®¹å™¨åœ¨è¿è¡Œæ—¶è¿›è¡Œç½‘ç»œè¿æ¥å’Œæ–­å¼€ã€‚

CNI å®é™…ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

|ç»„æˆ|è¯´æ˜|
|---|---|
|ğŸ§© CNI è§„èŒƒ|å®šä¹‰äº†å®¹å™¨ç½‘ç»œæ’ä»¶å¦‚ä½•ä¸å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ kubeletã€containerdï¼‰äº¤äº’çš„æ¥å£è§„èŒƒ|
|âš™ï¸ CNI æ’ä»¶|å®ç°å…·ä½“ç½‘ç»œåŠŸèƒ½çš„ç¨‹åºï¼Œå¦‚ `bridge`ã€`calico`ã€`flannel`ã€`cilium` ç­‰|

é»˜è®¤é…ç½®æ–‡ä»¶è·¯å¾„ï¼š/etc/cni/net.d/10-my-cni.conf

**CNI ä¸ Kubernetesã€containerd çš„å…³ç³»**
- Kubernetesä¸è´Ÿè´£å®¹å™¨ç½‘ç»œé…ç½®ï¼Œè€Œæ˜¯è°ƒç”¨ kubelet â†’ containerd â†’ CNI æ’ä»¶å®Œæˆã€‚
- cniçš„é…ç½®åªå’Œcontainerdç›¸å…³ï¼Œå¯é€šè¿‡daemonsetæ–¹å¼è¿è¡Œåœ¨k8sé›†ç¾¤ä¸­ï¼ˆcniæ’ä»¶æœ‰å¤šç§éƒ¨ç½²æ–¹å¼ï¼‰ï¼Œå¦‚calicoã€flannel
- cniæ’ä»¶åœ¨k8sé›†ç¾¤ä¸­æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºk8sæœ¬èº«ä¸æä¾›ç½‘ç»œå®ç°ï¼Œcnié€šè¿‡æ’ä»¶çš„æ–¹å¼æ¥æä¾›ç½‘ç»œåŠŸèƒ½ï¼ŒåŒ…æ‹¬åˆ†é…podçš„ip
CNIç½‘ç»œæ’ä»¶æœ‰å¾ˆå¤šï¼Œåˆ†åˆ«æä¾›å·®å¼‚åŒ–çš„åŠŸèƒ½ï¼Œå¸¸è§çš„CNIæ’ä»¶åˆ—è¡¨ï¼š
https://kubernetes.io/zh-cn/docs/concepts/cluster-administration/addons/#networking-and-network-policy

==**Calicoï¼š**==

calicoå®˜æ–¹yamlï¼š
https://raw.githubusercontent.com/projectcalico/calico/v3.27.4/manifests/calico.yaml

å¯ä¿®æ”¹çš„å‚æ•°1ï¼š
```yaml
- name: CALICO_IPV4POOL_CIDR
  value: "10.233.64.0/18"
```
æ­¤å€¼æ˜¯calicoçš„IPAMçš„ippoolèµ„æºä¸­ipæ± ï¼Œå³ä½¿ä¸è®¾ç½®æ­¤å€¼ï¼Œcalicoä¹Ÿä¼šä½¿ç”¨è‡ªå·±é»˜è®¤çš„ippoolï¼š192.168.0.0/16ã€‚Calico é»˜è®¤ä¸ä½¿ç”¨ kube-controller-manager åˆ†é…çš„ podCIDRï¼ˆNode.spec.podCIDRï¼‰ã€‚

å¯ä¿®æ”¹çš„å‚æ•°2ï¼š
```yaml
        - name: KUBERNETES_SERVICE_HOST
          value: 10.233.0.1
        - name: KUBERNETES_SERVICE_PORT
          value: "443"
```
å¦‚æœé›†ç¾¤å·²ç»è‡ªåŠ¨æ³¨å…¥äº†è¯¥ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥ **åˆ é™¤è¿™ä¸€é¡¹**ï¼ŒCalico ä¼šä»ç¯å¢ƒä¸­è¯»å–

éƒ¨ç½²
```bash
kubectl apply -f calico.yaml
```

ä½¿ç”¨å®˜æ–¹çš„calico yamléƒ¨ç½²cniæ’ä»¶åï¼Œä¼šè‡ªåŠ¨åˆ›å»ºippoolçš„pod ipæ± èµ„æºï¼ŒæŸ¥è¯¢
```bash
kubectl get ippool -A
```

æµ‹è¯•éƒ¨ç½²ä¸€ä¸ªbusyboxåº”ç”¨ï¼ŒæŸ¥çœ‹å…¶ip
```bash
kubectl run busybox --image=registry.cn-beijing.aliyuncs.com/alphesh-soft/busybox:latest --restart=Never -it --rm -- /bin/sh
```


==**æ‹“å±•**==
åè¯åŸºæœ¬æ¦‚å¿µï¼š
- ClusterIPï¼šå±äºservice CIDRèŒƒå›´ï¼Œåˆ†é…ç»™serviceçš„è™šæ‹Ÿip
- Pod IPï¼šåˆ†é…ç»™æŸä¸ª Pod çš„å…·ä½“ IP åœ°å€ï¼ˆå¦‚ `10.244.1.5`ï¼‰
- Pod CIDRï¼šåˆ†é…ç»™nodeèŠ‚ç‚¹çš„podCIDRå€¼ï¼Œåœ¨calicoæ’ä»¶ä¸­æ­¤å€¼æ— å®é™…æ„ä¹‰ã€‚

##### ä¸€ï¼šk8sé›†ç¾¤ä¸­ipçš„åˆ†é…æµç¨‹ï¼š
1ï¼ŒService IP åˆ†é…ï¼ˆClusterIP / Service CIDRï¼‰
åˆ†é…æµç¨‹ï¼š
- ç”¨æˆ·åˆ›å»ºä¸€ä¸ª Serviceï¼ˆå¦‚ ClusterIP ç±»å‹ï¼‰æ—¶ï¼Œ**æ²¡æœ‰æŒ‡å®š `clusterIP`**ã€‚
- kube-apiserver è‡ªåŠ¨ä» `--service-cluster-ip-range` ä¸­é€‰æ‹©ä¸€ä¸ªæœªåˆ†é…çš„ IPï¼Œè¿™é‡Œä¹Ÿå¯ä»¥åœ¨yamlä¸­æ‰‹åŠ¨æŒ‡å®šClusterIPã€‚
- è¯¥ IP ä¼šè¢«è®°å½•åœ¨ etcd ä¸­ï¼Œæ•´ä¸ªé›†ç¾¤å…±äº«ã€‚
- kube-proxy å°†ç›‘å¬è¯¥ IPï¼Œå¹¶è½¬å‘åˆ°åç«¯ Pod

2ï¼ŒPod IP åˆ†é…ï¼ˆPod CIDR / Cluster CIDRï¼‰
åˆ†é…æµç¨‹ï¼š
é€šè¿‡CNIæ’ä»¶çš„IPAMï¼ˆIPåœ°å€ç®¡ç†ï¼‰åˆ†é…ï¼Œ**å¸¸è§æ’ä»¶ï¼ˆCalicoã€Ciliumï¼‰**ï¼Œç›®å‰æ›´å¤šçš„æ’ä»¶ä½¿ç”¨æ­¤æ–¹å¼
åœ¨calico-nodeé…ç½®ä¸­æ·»åŠ 
```yaml
- name: CALICO_IPV4POOL_CIDR
  value: "10.233.64.0/18"
```
- **Kubelet å¯åŠ¨ Pod**ï¼Œè°ƒç”¨ CNI æ’ä»¶é…ç½® Pod ç½‘ç»œã€‚
- **Calico CNI æ’ä»¶å¯åŠ¨**ï¼Œå®ƒè°ƒç”¨ Calico çš„ `calico-ipam` æ¨¡å—ã€‚
- `calico-ipam` ä»å·²ç»åˆ›å»ºçš„ IPPoolï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ä¸­é€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„ IPã€‚
- å°†è¯¥ IP åˆ†é…ç»™ Podã€‚
 - è¯¥åˆ†é…ä¿¡æ¯ä¼šè¢«è®°å½•åœ¨ Calico çš„èµ„æºä¸­ï¼ˆå¦‚ IPAM blocksã€allocations ç­‰ï¼‰ã€‚
ğŸ’¡ **æ³¨æ„**ï¼šè¿™å®Œå…¨ç»•è¿‡äº† Kubernetes è‡ªå¸¦çš„ `podCIDR`ï¼ŒCalico ä¸éœ€è¦ä¾èµ– kube-controller-manager æ¥åˆ†é… podCIDRã€‚

å¦ï¼šå¦‚æœä¸€å®šè¦æŒ‰podCIDRæ¥åˆ†é…ipï¼Œå¯ä»¥åˆ›å»ºæ¯ä¸ªNodeçš„ippoolï¼Œåœ¨å…¶yamlä¸­æŒ‡å®šnodeSelecterï¼Œç„¶ååœ¨åˆ›å»ºpodæ—¶æŒ‡å®šnodeSelecterã€‚å³åˆ›å»ºpodæ—¶è¯»å–æ‰€æœ‰ippoolèµ„æºï¼Œæ ¹æ®nodeSelecterå€¼æ¥é€‰æ‹©ippoolï¼Œç„¶åæ ¹æ®å…¶åˆ†é…ipã€‚è¿™ä¸ªè¿‡ç¨‹podCIDRå®é™…æœªå‚ä¸ï¼Œåªæ˜¯æŒ‰å…¶æ¥åˆ›å»ºippoolã€‚
ippool.yaml
```yaml
apiVersion: crd.projectcalico.org/v1
kind: IPPool
metadata:
  name: ippool-test-node-01
spec:
  cidr: 10.233.67.0/24
  ipipMode: Always
  vxlanMode: Never
  natOutgoing: true
  nodeSelector: "kubernetes.io/hostname == 'test-node-01'"

```

deployment.yaml
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: busybox
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: busybox
  template:
    metadata:
      labels:
        app: busybox
    spec:
      nodeSelector:
        kubernetes.io/hostname: test-node-01
      containers:
      - name: busybox
        image: registry.cn-beijing.aliyuncs.com/alphesh-soft/busybox:latest
        command: ["/bin/sh"]
        args: ["-c", "sleep 3600"]
        tty: true
        stdin: true

```



éƒ¨ç½²HA-proxy





é…ç½® RBAC å’Œ Bootstrap Token



éƒ¨ç½² CoreDNS